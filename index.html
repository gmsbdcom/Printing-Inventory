<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Printing Inventory 1.1</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challan & Bill Management System</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        /* Login Page Styles */
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .login-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><pattern id="warehouse" patternUnits="userSpaceOnUse" width="200" height="200"><rect width="200" height="200" fill="%23f8f9fa" opacity="0.1"/><rect x="20" y="40" width="160" height="120" fill="%23ffffff" opacity="0.05" stroke="%23ffffff" stroke-width="2"/><rect x="40" y="60" width="30" height="80" fill="%23ffffff" opacity="0.1"/><rect x="80" y="60" width="30" height="80" fill="%23ffffff" opacity="0.1"/><rect x="120" y="60" width="30" height="80" fill="%23ffffff" opacity="0.1"/><circle cx="170" cy="170" r="8" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23warehouse)"/></svg>');
            filter: blur(2px);
            opacity: 0.3;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .company-logo-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .company-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .company-subtitle {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .login-form {
            width: 100%;
        }
        
        .input-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .login-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            box-sizing: border-box;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .login-input::placeholder {
            color: #bdc3c7;
        }
        
        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-direction: column;
        }
        
        .login-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
        }
        
        .login-btn-primary {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .login-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .login-btn-secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .login-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .login-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .login-footer p {
            color: #7f8c8d;
            font-size: 12px;
            margin: 0;
        }
        
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
        .nav-gradient {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .print-template {
            background: white;
            padding: 10px;
            margin: 0;
            border: 1px solid #333;
            font-family: Times New Roman, sans-serif;
            font-size: 12px;
        }
        
        .company-header {
            text-align: center;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        
        .company-logo {
            max-width: 80px;
            height: auto;
        }
        
        .document-title {
            font-size: 16px;
            font-weight: bold;
            margin: 8px 0;
            text-align: center;
        }
        
        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 8px 0;
            font-size: 11px;
        }
        
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 10px;
        }
        
        .signature-box {
            text-align: center;
            width: 18%;
        }
        
        .signature-line {
            margin-top: 35px;
            font-size: 10px;
            padding-top: 8px;
            border-top: 1px solid #333;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 10px;
        }
        
        .print-table th, .print-table td {
            border: 1px solid #333;
            padding: 3px;
            text-align: left;
        }
        
        .print-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            font-size: 9px;
        }
        
        .hide-in-challan {
            display: none;
        }
        
        /* Password Change Modal */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .password-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn-primary {
            background: #27ae60;
            color: white;
        }
        
        .modal-btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-1px);
        }
        
        /* Animation for login card */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-card {
            animation: slideInUp 0.6s ease-out;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .login-card {
                margin: 20px;
                padding: 30px 25px;
            }
            
            .company-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body class="w3-light-grey">
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="company-logo-section">
                <!-- LOGO ADDED HERE -->
                <img src="https://logic.gmsbd.com/platform/file_upload/company_details_1_5639_0.jpg" alt="Company Logo" style="max-width: 100px; margin-bottom: 15px;">
                <div class="company-title">GMS COMPOSITE KNITTING IND LTD</div>
                <div class="company-subtitle">Challan & Bill Management System</div>
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label class="input-label">USER NAME</label>
                    <input type="text" id="username" class="login-input" placeholder="Enter your username" required>
                </div>
                
                <div class="input-group">
                    <label class="input-label">PASSWORD</label>
                    <input type="password" id="password" class="login-input" placeholder="Enter your password" required>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="login-btn login-btn-primary">
                        🔐 LOGIN
                    </button>
                    <button type="button" class="login-btn login-btn-secondary" onclick="showPasswordChangeModal()">
                        🔑 Change Password
                    </button>
                </div>
            </form>
            
            <div class="login-footer">
                <p>© 2025 GMS Composite Knitting Ind Ltd. All rights reserved.</p>
                <p>Developed By: S@ju.TM</p>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="passwordModal" class="password-modal">
        <div class="password-modal-content">
            <div class="modal-title">🔑 Change Password</div>
            <form onsubmit="handlePasswordChange(event)">
                <div class="input-group">
                    <label class="input-label">Authorization Code</label>
                    <input type="password" id="authCode" class="login-input" placeholder="Enter authorization code" required>
                </div>
                
                <div class="input-group">
                    <label class="input-label">New Username</label>
                    <input type="text" id="newUsername" class="login-input" placeholder="Enter new username" required>
                </div>
                
                <div class="input-group">
                    <label class="input-label">New Password</label>
                    <input type="password" id="newPassword" class="login-input" placeholder="Enter new password" required>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="login-input" placeholder="Confirm new password" required>
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="modal-btn modal-btn-primary">Update Password</button>
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closePasswordModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Navigation -->
    <div class="w3-bar nav-gradient w3-card no-print" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: none;">
        <button onclick="showPage('home')" class="nav-link w3-bar-item w3-button w3-blue w3-hover-light-blue">
            🏠 Home
        </button>
        <button onclick="showPage('challan')" class="nav-link w3-bar-item w3-button w3-hover-blue">
            📋 Create Challan
        </button>
        <button onclick="showPage('recent')" class="nav-link w3-bar-item w3-button w3-hover-blue">
            📊 Recent Challans & Bills
        </button>
        <button onclick="logout()" class="w3-bar-item w3-button w3-hover-red w3-right">
            🚪 Logout
        </button>
    </div>

    <!-- Page Content -->
    <div class="w3-container" style="margin-top: 60px; display: none;">
        <!-- Home Page -->
        <div id="home" class="page-section active">
            <div class="w3-card-4 w3-white w3-round-large w3-padding-large">
                <h1 class="w3-text-dark-grey w3-xxxlarge w3-margin-bottom">Challan & Bill Management System</h1>
                
                <!-- Dashboard Filter Section -->
                <div class="w3-panel w3-pale-blue w3-round w3-margin-bottom">
                    <h3 class="w3-text-blue">📊 Dashboard Filter</h3>
                    <div class="w3-row-padding">
                        <div class="w3-third">
                            <label class="w3-text-grey">From Date</label>
                            <input type="date" id="dashFromDate" class="w3-input w3-border w3-round" onchange="updateDashboard()">
                        </div>
                        <div class="w3-third">
                            <label class="w3-text-grey">To Date</label>
                            <input type="date" id="dashToDate" class="w3-input w3-border w3-round" onchange="updateDashboard()">
                        </div>
                        <div class="w3-third">
                            <label class="w3-text-grey">Party Name</label>
                            <input list="dashPartyList" type="text" id="dashPartyFilter" class="w3-input w3-border w3-round" placeholder="All parties" onchange="updateDashboard()">
                            <datalist id="dashPartyList"></datalist>
                        </div>
                    </div>
                    <div class="w3-margin-top">
                        <button onclick="clearDashboardFilter()" class="w3-button w3-grey w3-small w3-round w3-margin-right">Clear Filter</button>
                        <button onclick="setDashboardToday()" class="w3-button w3-blue w3-small w3-round w3-margin-right">Today</button>
                        <button onclick="setDashboardThisWeek()" class="w3-button w3-green w3-small w3-round w3-margin-right">This Week</button>
                        <button onclick="setDashboardThisMonth()" class="w3-button w3-orange w3-small w3-round">This Month</button>
                    </div>
                </div>

                <!-- Dashboard Statistics -->
                <div class="w3-row-padding w3-margin-bottom">
                    <div class="w3-quarter">
                        <div class="w3-card w3-blue w3-padding w3-round w3-center">
                            <div class="w3-text-white w3-xxxlarge w3-margin-bottom">📋</div>
                            <h2 class="w3-text-white w3-margin-bottom" id="totalChallans">0</h2>
                            <p class="w3-text-white w3-large">Total Challans</p>
                        </div>
                    </div>
                    <div class="w3-quarter">
                        <div class="w3-card w3-green w3-padding w3-round w3-center">
                            <div class="w3-text-white w3-xxxlarge w3-margin-bottom">💰</div>
                            <h2 class="w3-text-white w3-margin-bottom" id="totalAmountUSD">$0</h2>
                            <p class="w3-text-white w3-large">Total Amount (USD)</p>
                        </div>
                    </div>
                    <div class="w3-quarter">
                        <div class="w3-card w3-orange w3-padding w3-round w3-center">
                            <div class="w3-text-white w3-xxxlarge w3-margin-bottom">৳</div>
                            <h2 class="w3-text-white w3-margin-bottom" id="totalAmountBDT">৳0</h2>
                            <p class="w3-text-white w3-large">Total Amount (BDT)</p>
                        </div>
                    </div>
                    <div class="w3-quarter">
                        <div class="w3-card w3-purple w3-padding w3-round w3-center">
                            <div class="w3-text-white w3-xxxlarge w3-margin-bottom">🏢</div>
                            <h2 class="w3-text-white w3-margin-bottom" id="uniqueParties">0</h2>
                            <p class="w3-text-white w3-large">Unique Parties</p>
                        </div>
                    </div>
                </div>

                <!-- Top Parties Section -->
                <div class="w3-row-padding w3-margin-bottom">
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-padding w3-round">
                            <h3 class="w3-text-dark-grey w3-margin-bottom">🏆 Top 5 Parties by Amount</h3>
                            <div id="topPartiesContainer">
                                <p class="w3-text-grey w3-center">Loading data...</p>
                            </div>
                        </div>
                    </div>
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-padding w3-round">
                            <h3 class="w3-text-dark-grey w3-margin-bottom">📈 Recent Activity</h3>
                            <div id="recentActivityContainer">
                                <p class="w3-text-grey w3-center">Loading data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Trend Chart -->
                <div class="w3-card w3-white w3-padding w3-round w3-margin-bottom">
                    <h3 class="w3-text-dark-grey w3-margin-bottom">📊 Monthly Trend</h3>
                    <div id="monthlyTrendContainer">
                        <div class="w3-responsive">
                            <table class="w3-table w3-striped w3-bordered">
                                <thead>
                                    <tr class="w3-blue">
                                        <th>Month</th>
                                        <th>Challans</th>
                                        <th>USD Amount</th>
                                        <th>BDT Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyTrendBody">
                                    <tr>
                                        <td colspan="4" class="w3-center w3-text-grey">Loading data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Action Cards -->
                <div class="w3-row-padding">
                    <div class="w3-half">
                        <div class="w3-card w3-pale-blue w3-padding w3-round">
                            <div class="w3-text-blue w3-xxlarge w3-margin-bottom">📋</div>
                            <h3 class="w3-text-dark-grey w3-large w3-margin-bottom">Create New Challan</h3>
                            <p class="w3-text-grey">Generate unique challan and bill numbers automatically</p>
                            <button onclick="showPage('challan')" class="w3-button w3-blue w3-round w3-margin-top">
                                Start Creating
                            </button>
                        </div>
                    </div>
                    <div class="w3-half">
                        <div class="w3-card w3-pale-green w3-padding w3-round">
                            <div class="w3-text-green w3-xxxlarge w3-margin-bottom">📊</div>
                            <h3 class="w3-text-dark-grey w3-large w3-margin-bottom">Recent Records</h3>
                            <p class="w3-text-grey">View and print saved challans and bills</p>
                            <button onclick="showPage('recent')" class="w3-button w3-green w3-round w3-margin-top">
                                View Records
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Challan Creation Page -->
        <div id="challan" class="page-section">
            <div class="w3-card-4 w3-white w3-round-large w3-padding-large">
                <div class="w3-row w3-margin-bottom">
                    <div class="w3-col s8">
                        <h1 class="w3-text-dark-grey w3-xxxlarge">Create New Challan</h1>
                    </div>
                    <div class="w3-col s4 w3-right-align">
                        <div class="w3-panel w3-pale-blue w3-round">
                            <p><strong>Challan No:</strong> <span id="currentChallanNo">Loading...</span></p>
                            <p><strong>Bill No:</strong> <span id="currentBillNo">Loading...</span></p>
                        </div>
                    </div>
                </div>

                <form onsubmit="handleChallanSubmit(event)" class="w3-container">
                    <!-- Basic Information -->
                    <div class="w3-panel w3-pale-blue w3-round w3-margin-bottom">
                        <h3 class="w3-text-blue">Basic Information</h3>
                    </div>
                    
                    <div class="w3-row-padding w3-margin-bottom">
                        <div class="w3-half">
                            <label class="w3-text-grey">Date</label>
                            <input type="date" id="challanDate" class="w3-input w3-border w3-round" required>
                        </div>
                        <div class="w3-half">
                            <label class="w3-text-grey">Department</label>
                            <input list="departmentList" type="text" id="department" class="w3-input w3-border w3-round" placeholder="Select or type department">
                            <datalist id="departmentList">
                                <option value="Narrow Fabrics Dyeing">
                                <option value="Washing">
                                <option value="Dyeing">
                            </datalist>
                        </div>
                    </div>

                    <!-- Party & Location Details -->
                    <div class="w3-panel w3-pale-green w3-round w3-margin-bottom">
                        <h3 class="w3-text-green">Party & Location Details</h3>
                    </div>

                    <div class="w3-row-padding w3-margin-bottom">
                        <div class="w3-half">
                            <label class="w3-text-grey">Party Name</label>
                            <input list="partyNameList" type="text" id="partyName" class="w3-input w3-border w3-round" placeholder="Select or type party name" required>
                            <datalist id="partyNameList">
                                <option value="Gms Trims Ltd">
                                <option value="Air Trims">
                                <option value="Asia Linkage">
                                <option value="Asr Thread & Accessories Ltd.">
                                <option value="Blue Planet Sweater Ltd.">
                                <option value="Db Trims Ltd.">
                                <option value="Gazaria Elastic Industries Ltd.">
                                <option value="Globel Premium Accessories Ltd.">
                                <option value="HANGZHOU SUNSHINE TRIMS">
                                <option value="Hernest Label Ind.Ltd.">
                                <option value="Jist Industrien Co.Ltd.">
                                <option value="MACK TRIMS LTD.">
                                <option value="Mahhdir Textiles Industries">
                                <option value="MK Accessories">
                                <option value="MM KNITWEAR LTD.">
                                <option value="PANDORA ACCESSORIES LTD.">
                                <option value="Papyrus FastQ (BD) Ltd.">
                                <option value="R.K.Garments Accessories Ind. Ltd.">
                                <option value="RAHIM TEXTILE MILLS LIMITED">
                                <option value="STANDARD NARROW FABRICS">
                                <option value="TAZRIYAN ACCESSORIES">
                                <option value="The Moon Trade">
                                <option value="TRIMSNET BANGLADESH">
                                <option value="URMI GARMENTS LTD.">
                                <option value="Texas Packages & Accessories Ltd.">
                            </datalist>
                        </div>
                        <div class="w3-half">
                            <label class="w3-text-grey">Location</label>
                            <input list="locationList" type="text" id="location" class="w3-input w3-border w3-round" placeholder="Select or type location">
                            <datalist id="locationList">
                                <option value="In House">
                                <option value="Out Side">
                            </datalist>
                        </div>
                    </div>

                    <div class="w3-margin-bottom">
                        <label class="w3-text-grey">Address</label>
                        <textarea id="address" class="w3-input w3-border w3-round" rows="3" placeholder="Enter complete address"></textarea>
                    </div>

                    <!-- Transport Details -->
                    <div class="w3-panel w3-pale-yellow w3-round w3-margin-bottom">
                        <h3 class="w3-text-orange">Transport Details</h3>
                    </div>

                    <div class="w3-row-padding w3-margin-bottom">
                        <div class="w3-third">
                            <label class="w3-text-grey">Gate Pass No</label>
                            <input type="text" id="gatePassNo" class="w3-input w3-border w3-round" placeholder="Enter gate pass number">
                        </div>
                        <div class="w3-third">
                            <label class="w3-text-grey">Transport No</label>
                            <input type="text" id="transportNo" class="w3-input w3-border w3-round" placeholder="Enter transport number">
                        </div>
                        <div class="w3-third">
                            <label class="w3-text-grey">Driver's Name</label>
                            <input type="text" id="driverName" class="w3-input w3-border w3-round" placeholder="Enter driver's name">
                        </div>
                    </div>

                    <div class="w3-row-padding w3-margin-bottom">
                        <div class="w3-half">
                            <label class="w3-text-grey">Item Description / Elastic Type</label>
                            <input list="elasticTypeList" type="text" id="itemDescription" class="w3-input w3-border w3-round" placeholder="Select or type elastic type/description">
                            <datalist id="elasticTypeList">
                                <option value="Crochet Elastic">
                                <option value="Ribbon Elastic">
                            </datalist>
                        </div>
                        <div class="w3-half">
                            <label class="w3-text-grey">Challan Details</label>
                            <textarea id="challanDetails" class="w3-input w3-border w3-round" rows="3" placeholder="Enter additional challan details, notes, or special instructions"></textarea>
                        </div>
                    </div>

                    <!-- Item Details Table -->
                    <div class="w3-panel w3-pale-red w3-round w3-margin-bottom">
                        <h3 class="w3-text-red">Item Details</h3>
                    </div>

                    <div class="w3-responsive w3-margin-bottom">
                        <table class="w3-table-all w3-hoverable w3-card" id="itemsTable">
                            <thead>
                                <tr class="w3-blue">
                                    <th>SL. NO</th>
                                    <th>Order No</th>
                                    <th>Colour</th>
                                    <th>Measurement</th>
                                    <th>Process</th>
                                    <th>UoM</th>
                                    <th>Kg</th>
                                    <th>Yds</th>
                                    <th>Bag</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                    <th>Currency</th>
                                    <th>Remarks</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <tr>
                                    <td>1</td>
                                    <td><input type="text" class="w3-input w3-border" placeholder="Order No"></td>
                                    <td><input type="text" class="w3-input w3-border" placeholder="Colour"></td>
                                    <td><input type="text" class="w3-input w3-border" placeholder="Measurement"></td>
                                    <td><input type="text" class="w3-input w3-border" placeholder="Process"></td>
                                    <td>
                                        <select class="w3-select w3-border uom-select" onchange="calculateAmount(this)">
                                            <option value="">Select UoM</option>
                                            <option value="kg">Kg</option>
                                            <option value="yds">Yds</option>
                                            <option value="sample">Sample</option>
                                            <option value="pcs">Pcs</option>
                                            <option value="mtr">Mtr</option>
                                        </select>
                                    </td>
                                    <td><input type="number" step="0.01" class="w3-input w3-border kg-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                                    <td><input type="number" step="0.01" class="w3-input w3-border yds-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                                    <td><input type="number" class="w3-input w3-border bag-input" placeholder="0" onchange="calculateAmount(this)"></td>
                                    <td><input type="number" step="0.01" class="w3-input w3-border rate-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                                    <td><input type="number" step="0.01" class="w3-input w3-border amount-input" placeholder="0.00" readonly></td>
                                    <td>
                                        <select class="w3-select w3-border currency-select" onchange="updateRowCurrency(this)">
                                            <option value="USD">USD ($)</option>
                                            <option value="BDT">BDT (৳)</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="w3-input w3-border remarks-input" placeholder="Enter remarks"></td>
                                    <td><button type="button" class="w3-button w3-red w3-small" onclick="removeRow(this)">Remove</button></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="w3-green">
                                    <td colspan="6" class="w3-center w3-large"><strong>GRAND TOTAL</strong></td>
                                    <td class="w3-center w3-large"><strong><span id="totalKg">0.00</span></strong></td>
                                    <td class="w3-center w3-large"><strong><span id="totalYds">0.00</span></strong></td>
                                    <td class="w3-center w3-large"><strong>-</strong></td>
                                    <td class="w3-center w3-large"><strong>-</strong></td>
                                    <td class="w3-center w3-large"><strong><span id="currencySymbol">$</span><span id="totalAmount">0.00</span></strong></td>
                                    <td class="w3-center">
                                        <select id="currencySelect" class="w3-select w3-border w3-green" onchange="updateCurrency()">
                                            <option value="USD">USD ($)</option>
                                            <option value="BDT">BDT (৳)</option>
                                        </select>
                                    </td>
                                    <td class="w3-center w3-large"><strong>-</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="w3-margin-bottom">
                        <button type="button" onclick="addNewRow()" class="w3-button w3-green w3-round w3-margin-right">+ Add New Item</button>
                    </div>

                    <div class="w3-margin-top">
                        <button type="submit" class="w3-button w3-blue w3-round w3-padding-large w3-hover-light-blue w3-margin-right">
                            Create Challan & Bill
                        </button>
                        <button type="button" onclick="resetForm()" class="w3-button w3-grey w3-round w3-padding-large w3-hover-light-grey">
                            Reset Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Recent Records Page -->
        <div id="recent" class="page-section">
            <div class="w3-card-4 w3-white w3-round-large w3-padding-large">
                <h1 class="w3-text-dark-grey w3-xxxlarge w3-margin-bottom">Recent Challans & Bills</h1>
                
                <div class="w3-row-padding w3-margin-bottom">
                    <div class="w3-half">
                        <input type="text" id="searchInput" class="w3-input w3-border w3-round" placeholder="Search by Challan No, Bill No, or Party Name..." onkeyup="filterRecords()">
                    </div>
                    <div class="w3-quarter">
                        <input type="date" id="fromDate" class="w3-input w3-border w3-round" placeholder="From Date" onchange="filterRecords()">
                        <label class="w3-text-grey w3-small">From Date</label>
                    </div>
                    <div class="w3-quarter">
                        <input type="date" id="toDate" class="w3-input w3-border w3-round" placeholder="To Date" onchange="filterRecords()">
                        <label class="w3-text-grey w3-small">To Date</label>
                    </div>
                </div>
                
                <div class="w3-margin-bottom">
                    <button onclick="clearDateFilter()" class="w3-button w3-grey w3-small w3-round w3-margin-right">Clear Date Filter</button>
                    <button onclick="setTodayFilter()" class="w3-button w3-blue w3-small w3-round w3-margin-right">Today</button>
                    <button onclick="setThisWeekFilter()" class="w3-button w3-green w3-small w3-round w3-margin-right">This Week</button>
                    <button onclick="setThisMonthFilter()" class="w3-button w3-orange w3-small w3-round w3-margin-right">This Month</button>
                    <button onclick="exportToExcel()" class="w3-button w3-purple w3-small w3-round">📊 Export to Excel</button>
                </div>

                <div class="w3-responsive">
                    <table class="w3-table-all w3-hoverable w3-card">
                        <thead>
                            <tr class="w3-blue">
                                <th>Challan No</th>
                                <th>Bill No</th>
                                <th>Party Name</th>
                                <th>Date</th>
                                <th>Total Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                            <tr>
                                <td colspan="6" class="w3-center w3-text-grey">Loading records...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Template -->
    <div id="printTemplate" class="print-area" style="display: none;">
        <div class="print-template">
            <div class="company-header">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <img src="https://logic.gmsbd.com/platform/file_upload/company_details_1_5639_0.jpg" alt="Company Logo" class="company-logo" style="margin: 0;">
                    <div style="text-align: left;">
                        <h2 style="margin: 0; font-size: 18px;">GMS COMPOSITE KNITTING IND LTD</h2>
                        <p style="margin: 5px 0 0 0; font-size: 12px;">Sardagonj, Kashimpur, Gazipur</p>
                    </div>
                </div>
            </div>
            
            <div class="document-title" id="printDocumentTitle">CHALLAN</div>
            
            <div class="info-section">
                <div>
                    <p style="margin: 2px 0;"><strong>Challan No:</strong> <span id="printChallanNo"></span></p>
                    <p style="margin: 2px 0;"><strong>Bill No:</strong> <span id="printBillNo"></span></p>
                    <p style="margin: 2px 0;"><strong>Date:</strong> <span id="printDate"></span></p>
                    <p style="margin: 2px 0;"><strong>Department:</strong> <span id="printDepartment"></span></p>
                </div>
                <div>
                    <p style="margin: 2px 0;"><strong>Party:</strong> <span id="printPartyName"></span></p>
                    <p style="margin: 2px 0;"><strong>Location:</strong> <span id="printLocation"></span></p>
                    <p style="margin: 2px 0;"><strong>Address:</strong> <span id="printAddress"></span></p>
                    <p style="margin: 2px 0;"><strong>Currency:</strong> <span id="printCurrency"></span></p>
                </div>
                <div>
                    <p style="margin: 2px 0;"><strong>Gate Pass No:</strong> <span id="printGatePassNo"></span></p>
                    <p style="margin: 2px 0;"><strong>Transport No:</strong> <span id="printTransportNo"></span></p>
                    <p style="margin: 2px 0;"><strong>Driver:</strong> <span id="printDriverName"></span></p>
                </div>
            </div>
            
            <table class="print-table" id="printItemsTable">
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Order No</th>
                        <th>Colour</th>
                        <th>Measurement</th>
                        <th>Process</th>
                        <th>UoM</th>
                        <th>Kg</th>
                        <th>Yds</th>
                        <th>Bag</th>
                        <th class="rate-amount-col">Rate</th>
                        <th class="rate-amount-col">Amount</th>
                        <th class="rate-amount-col">Currency</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody id="printItemsTableBody">
                </tbody>
                <!-- FIXED: Added table footer for grand totals -->
                <tfoot id="printTableFooter">
                    <tr style="font-weight: bold;">
                        <td colspan="6" style="text-align: center;">GRAND TOTAL</td>
                        <td id="printTotalKg">0.00</td>
                        <td id="printTotalYds">0.00</td>
                        <td></td> <!-- Bag -->
                        <td class="rate-amount-col"></td> <!-- Rate -->
                        <td class="rate-amount-col" id="printGrandTotalAmount"></td> <!-- Amount -->
                        <td class="rate-amount-col"></td> <!-- Currency -->
                        <td></td> <!-- Remarks -->
                    </tr>
                </tfoot>
            </table>
            
            <div style="text-align: right; margin: 8px 0; font-size: 11px;">
                <p class="rate-amount-col" style="margin: 0;"><strong>Total Amount: <span id="printTotalAmount"></span></strong></p>
            </div>
            
            <div id="amountInWordsSection" class="rate-amount-col" style="margin: 8px 0; font-size: 11px; display: none;">
                <p style="margin: 0;"><strong>Amount In Words:</strong> <span id="printAmountInWords"></span></p>
            </div>
            
            <div style="font-size: 10px; margin: 5px 0;">
                <p style="margin: 2px 0;"><strong>Item Description:</strong> <span id="printItemDescription"></span></p>
                <p style="margin: 2px 0;"><strong>Challan Details:</strong> <span id="printChallanDetails"></span></p>
            </div>
            
            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line">Prepared by</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">Receiver's Signature</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">Checked by</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">AGM Inventory</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">Approved by</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            databaseURL: "https://inventory-management-f47b0-default-rtdb.firebaseio.com/"
        };

        // Global variables
        let currentChallanNumber = '';
        let currentBillNumber = '';
        let rowCounter = 1;
        let allRecords = [];
        let editingRecordId = null;
        let isLoggedIn = false;

        // Login credentials (stored in localStorage)
        let loginCredentials = {
            username: localStorage.getItem('app_username') || 'admin',
            password: localStorage.getItem('app_password') || 'admin123'
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });

        // Check if user is logged in
        function checkLoginStatus() {
            const loginStatus = sessionStorage.getItem('isLoggedIn');
            if (loginStatus === 'true') {
                isLoggedIn = true;
                hideLoginPage();
                initializeApp();
            } else {
                showLoginPage();
            }
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.querySelector('.w3-bar').style.display = 'none';
            document.querySelector('.w3-container').style.display = 'none';
        }

        // Hide login page
        function hideLoginPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.querySelector('.w3-bar').style.display = 'block';
            document.querySelector('.w3-container').style.display = 'block';
        }

        // Initialize app after login
        function initializeApp() {
            generateUniqueNumbers();
            setCurrentDate();
            loadRecords();
            initializeDashboard();
        }

        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === loginCredentials.username && password === loginCredentials.password) {
                isLoggedIn = true;
                sessionStorage.setItem('isLoggedIn', 'true');
                hideLoginPage();
                initializeApp();
                
                // Clear login form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Show success message
                setTimeout(() => {
                    alert('🎉 সফলভাবে লগ ইন হয়েছে!\n\nWelcome to GMS Composite Knitting Inventory System');
                }, 500);
            } else {
                alert('❌ ভুল ইউজারনেম বা পাসওয়ার্ড!\n\nঅনুগ্রহ করে সঠিক তথ্য দিন।');
                document.getElementById('password').value = '';
            }
        }

        // Logout function
        function logout() {
            if (confirm('আপনি কি নিশ্চিত যে লগ আউট করতে চান?')) {
                isLoggedIn = false;
                sessionStorage.removeItem('isLoggedIn');
                showLoginPage();
                
                // Reset all forms and data
                resetForm();
                allRecords = [];
                dashboardData = [];
                
                alert('✅ সফলভাবে লগ আউট হয়েছে!');
            }
        }

        // Show password change modal
        function showPasswordChangeModal() {
            document.getElementById('passwordModal').style.display = 'flex';
        }

        // Close password change modal
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            // Clear form
            document.getElementById('authCode').value = '';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // Handle password change
        function handlePasswordChange(event) {
            event.preventDefault();
            
            const authCode = document.getElementById('authCode').value;
            const newUsername = document.getElementById('newUsername').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Check authorization code
            if (authCode !== '290144') {
                alert('❌ আপনার অনুমতি নেই!\n\nসঠিক অনুমতি কোড দিন।');
                return;
            }
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                alert('❌ পাসওয়ার্ড মিলছে না!\n\nঅনুগ্রহ করে একই পাসওয়ার্ড দুইবার দিন।');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 4) {
                alert('❌ পাসওয়ার্ড খুবই ছোট!\n\nকমপক্ষে ৪ অক্ষরের পাসওয়ার্ড দিন।');
                return;
            }
            
            // Validate username
            if (newUsername.length < 3) {
                alert('❌ ইউজারনেম খুবই ছোট!\n\nকমপক্ষে ৩ অক্ষরের ইউজারনেম দিন।');
                return;
            }
            
            // Update credentials
            loginCredentials.username = newUsername;
            loginCredentials.password = newPassword;
            
            // Save to localStorage
            localStorage.setItem('app_username', newUsername);
            localStorage.setItem('app_password', newPassword);
            
            closePasswordModal();
            
            alert('✅ পাসওয়ার্ড সফলভাবে পরিবর্তন হয়েছে!\n\n🔐 নতুন ইউজারনেম: ' + newUsername + '\n🔑 নতুন পাসওয়ার্ড সেট করা হয়েছে\n\nপরবর্তী লগ ইনে নতুন তথ্য ব্যবহার করুন।');
        }

        // Generate unique challan and bill numbers
        async function generateUniqueNumbers() {
            const currentYear = new Date().getFullYear();
            
            try {
                // Get counters from Firebase
                const countersResponse = await fetch(`${firebaseConfig.databaseURL}/counters.json`);
                let countersData = await countersResponse.json();
                
                // Initialize counters if they don't exist
                if (!countersData) {
                    countersData = {
                        challanCounter: 1,
                        billCounter: 1
                    };
                    await fetch(`${firebaseConfig.databaseURL}/counters.json`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(countersData)
                    });
                }
                
                const challanCounter = countersData.challanCounter || 1;
                const billCounter = countersData.billCounter || 1;
                
                currentChallanNumber = `CH-${currentYear}-${challanCounter.toString().padStart(6, '0')}`;
                currentBillNumber = `BILL-${currentYear}-${billCounter.toString().padStart(6, '0')}`;
                
                document.getElementById('currentChallanNo').textContent = currentChallanNumber;
                document.getElementById('currentBillNo').textContent = currentBillNumber;
                
            } catch (error) {
                console.error('Error loading counters from Firebase:', error);
                // Fallback to localStorage if Firebase fails
                let challanCounter = parseInt(localStorage.getItem('challanCounter') || '1');
                let billCounter = parseInt(localStorage.getItem('billCounter') || '1');
                
                currentChallanNumber = `CH-${currentYear}-${challanCounter.toString().padStart(6, '0')}`;
                currentBillNumber = `BILL-${currentYear}-${billCounter.toString().padStart(6, '0')}`;
                
                document.getElementById('currentChallanNo').textContent = currentChallanNumber;
                document.getElementById('currentBillNo').textContent = currentBillNumber;
            }
        }

        // Set current date
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('challanDate').value = today;
        }

        // Save data to Firebase
        async function saveToFirebase(data) {
            try {
                // Save challan data
                const response = await fetch(`${firebaseConfig.databaseURL}/challans.json`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    // Update counters in Firebase
                    try {
                        const countersResponse = await fetch(`${firebaseConfig.databaseURL}/counters.json`);
                        let countersData = await countersResponse.json();
                        
                        if (!countersData) {
                            countersData = { challanCounter: 1, billCounter: 1 };
                        }
                        
                        // Increment counters
                        countersData.challanCounter = (countersData.challanCounter || 1) + 1;
                        countersData.billCounter = (countersData.billCounter || 1) + 1;
                        
                        // Save updated counters to Firebase
                        await fetch(`${firebaseConfig.databaseURL}/counters.json`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(countersData)
                        });
                        
                        // Also update localStorage as backup
                        localStorage.setItem('challanCounter', countersData.challanCounter.toString());
                        localStorage.setItem('billCounter', countersData.billCounter.toString());
                        
                    } catch (counterError) {
                        console.error('Error updating counters in Firebase:', counterError);
                        // Fallback to localStorage increment
                        let challanCounter = parseInt(localStorage.getItem('challanCounter') || '1');
                        let billCounter = parseInt(localStorage.getItem('billCounter') || '1');
                        
                        localStorage.setItem('challanCounter', (challanCounter + 1).toString());
                        localStorage.setItem('billCounter', (billCounter + 1).toString());
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                return false;
            }
        }

        // Update existing record in Firebase
        async function updateRecord(recordId, data) {
            try {
                const response = await fetch(`${firebaseConfig.databaseURL}/challans/${recordId}.json`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                return response.ok;
            } catch (error) {
                console.error('Error updating record in Firebase:', error);
                return false;
            }
        }

        // Dashboard Functions
        let dashboardData = [];

        function initializeDashboard() {
            populatePartyList();
            updateDashboard();
        }

        function populatePartyList() {
            const partyList = document.getElementById('dashPartyList');
            const uniqueParties = [...new Set(allRecords.map(record => record.partyName))];
            
            partyList.innerHTML = uniqueParties.map(party => `<option value="${party}">`).join('');
        }

        function updateDashboard() {
            const fromDate = document.getElementById('dashFromDate').value;
            const toDate = document.getElementById('dashToDate').value;
            const partyFilter = document.getElementById('dashPartyFilter').value.toLowerCase();
            
            // Filter records based on dashboard filters
            dashboardData = allRecords.filter(record => {
                let matchesDate = true;
                let matchesParty = true;
                
                // Date filter
                if (fromDate || toDate) {
                    const recordDate = new Date(record.date);
                    
                    if (fromDate) {
                        const fromDateTime = new Date(fromDate);
                        matchesDate = matchesDate && recordDate >= fromDateTime;
                    }
                    
                    if (toDate) {
                        const toDateTime = new Date(toDate);
                        toDateTime.setHours(23, 59, 59, 999);
                        matchesDate = matchesDate && recordDate <= toDateTime;
                    }
                }
                
                // Party filter
                if (partyFilter) {
                    matchesParty = record.partyName.toLowerCase().includes(partyFilter);
                }
                
                return matchesDate && matchesParty;
            });
            
            updateDashboardStats();
            updateTopParties();
            updateRecentActivity();
            updateMonthlyTrend();
        }

        function updateDashboardStats() {
            const totalChallans = dashboardData.length;
            let totalUSD = 0;
            let totalBDT = 0;
            const uniqueParties = new Set();
            
            dashboardData.forEach(record => {
                const amount = parseFloat(record.totalAmount) || 0;
                if (record.currency === 'USD') {
                    totalUSD += amount;
                } else if (record.currency === 'BDT') {
                    totalBDT += amount;
                }
                uniqueParties.add(record.partyName);
            });
            
            document.getElementById('totalChallans').textContent = totalChallans.toLocaleString();
            document.getElementById('totalAmountUSD').textContent = '$' + totalUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalAmountBDT').textContent = '৳' + totalBDT.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('uniqueParties').textContent = uniqueParties.size;
        }

        function updateTopParties() {
            const partyTotals = {};
            
            dashboardData.forEach(record => {
                const party = record.partyName;
                const amount = parseFloat(record.totalAmount) || 0;
                const currency = record.currency;
                
                if (!partyTotals[party]) {
                    partyTotals[party] = { USD: 0, BDT: 0, totalChallans: 0 };
                }
                
                partyTotals[party][currency] += amount;
                partyTotals[party].totalChallans += 1;
            });
            
            // Convert to array and sort by total value (USD + BDT converted to USD for comparison)
            const sortedParties = Object.entries(partyTotals)
                .map(([party, data]) => ({
                    party,
                    ...data,
                    totalValue: data.USD + (data.BDT / 110) // Rough conversion for sorting
                }))
                .sort((a, b) => b.totalValue - a.totalValue)
                .slice(0, 5);
            
            const container = document.getElementById('topPartiesContainer');
            
            if (sortedParties.length === 0) {
                container.innerHTML = '<p class="w3-text-grey w3-center">No data available</p>';
                return;
            }
            
            container.innerHTML = sortedParties.map((item, index) => `
                <div class="w3-panel w3-border-left w3-border-${index === 0 ? 'gold' : index === 1 ? 'silver' : 'brown'} w3-pale-${index === 0 ? 'yellow' : index === 1 ? 'grey' : 'red'} w3-margin-bottom">
                    <h4 class="w3-margin-bottom">${index + 1}. ${item.party}</h4>
                    <p class="w3-small w3-margin-bottom">
                        <strong>USD:</strong> $${item.USD.toLocaleString('en-US', {minimumFractionDigits: 2})} | 
                        <strong>BDT:</strong> ৳${item.BDT.toLocaleString('en-US', {minimumFractionDigits: 2})}
                    </p>
                    <p class="w3-small w3-text-grey">Total Challans: ${item.totalChallans}</p>
                </div>
            `).join('');
        }

        function updateRecentActivity() {
            const recentRecords = dashboardData
                .sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date))
                .slice(0, 5);
            
            const container = document.getElementById('recentActivityContainer');
            
            if (recentRecords.length === 0) {
                container.innerHTML = '<p class="w3-text-grey w3-center">No recent activity</p>';
                return;
            }
            
            container.innerHTML = recentRecords.map(record => `
                <div class="w3-panel w3-border-left w3-border-blue w3-pale-blue w3-margin-bottom">
                    <p class="w3-small w3-margin-bottom">
                        <strong>${record.challanNumber}</strong> - ${record.partyName}
                    </p>
                    <p class="w3-small w3-text-grey">
                        ${new Date(record.date).toLocaleDateString()} | 
                        ${record.currency === 'USD' ? '$' : '৳'}${parseFloat(record.totalAmount).toLocaleString('en-US', {minimumFractionDigits: 2})}
                    </p>
                </div>
            `).join('');
        }

        function updateMonthlyTrend() {
            const monthlyData = {};
            
            dashboardData.forEach(record => {
                const date = new Date(record.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { challans: 0, USD: 0, BDT: 0 };
                }
                
                monthlyData[monthKey].challans += 1;
                const amount = parseFloat(record.totalAmount) || 0;
                monthlyData[monthKey][record.currency] += amount;
            });
            
            const sortedMonths = Object.entries(monthlyData)
                .sort(([a], [b]) => b.localeCompare(a))
                .slice(0, 6);
            
            const tbody = document.getElementById('monthlyTrendBody');
            
            if (sortedMonths.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="w3-center w3-text-grey">No data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = sortedMonths.map(([month, data]) => {
                const monthName = new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                return `
                    <tr>
                        <td>${monthName}</td>
                        <td class="w3-center">${data.challans}</td>
                        <td class="w3-right-align">$${data.USD.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td class="w3-right-align">৳${data.BDT.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            }).join('');
        }

        // Dashboard filter functions
        function clearDashboardFilter() {
            document.getElementById('dashFromDate').value = '';
            document.getElementById('dashToDate').value = '';
            document.getElementById('dashPartyFilter').value = '';
            updateDashboard();
        }

        function setDashboardToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dashFromDate').value = today;
            document.getElementById('dashToDate').value = today;
            updateDashboard();
        }

        function setDashboardThisWeek() {
            const today = new Date();
            const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
            const lastDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            
            document.getElementById('dashFromDate').value = firstDayOfWeek.toISOString().split('T')[0];
            document.getElementById('dashToDate').value = lastDayOfWeek.toISOString().split('T')[0];
            updateDashboard();
        }

        function setDashboardThisMonth() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('dashFromDate').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('dashToDate').value = lastDayOfMonth.toISOString().split('T')[0];
            updateDashboard();
        }

        // Load records from Firebase
        async function loadRecords() {
            try {
                const response = await fetch(`${firebaseConfig.databaseURL}/challans.json`);
                const data = await response.json();
                
                allRecords = [];
                if (data) {
                    Object.keys(data).forEach(key => {
                        allRecords.push({ id: key, ...data[key] });
                    });
                }
                
                displayRecords(allRecords);
                populatePartyList();
                updateDashboard();
            } catch (error) {
                console.error('Error loading records:', error);
                document.getElementById('recordsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="w3-center w3-text-red">Error loading records</td></tr>';
            }
        }

        // Display records in table
        let filteredRecords = []; // Store filtered records for export
        
        function displayRecords(records) {
            filteredRecords = records; // Store for export
            const tbody = document.getElementById('recordsTableBody');
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="w3-center w3-text-grey">No records found</td></tr>';
                return;
            }
            
            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>${record.challanNumber}</td>
                    <td>${record.billNumber}</td>
                    <td>${record.partyName}</td>
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>${record.currency === 'USD' ? '$' : '৳'}${record.totalAmount}</td>
                    <td>
                        <button onclick="editRecord('${record.id}')" class="w3-button w3-orange w3-small w3-margin-right">Edit</button>
                        <button onclick="printDocument('${record.id}', 'challan')" class="w3-button w3-blue w3-small w3-margin-right">Print Challan</button>
                        <button onclick="printDocument('${record.id}', 'bill')" class="w3-button w3-green w3-small">Print Bill</button>
                    </td>
                </tr>
            `).join('');
        }

        // Filter records
        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            const filteredRecords = allRecords.filter(record => {
                // Text search filter
                const matchesSearch = record.challanNumber.toLowerCase().includes(searchTerm) ||
                                    record.billNumber.toLowerCase().includes(searchTerm) ||
                                    record.partyName.toLowerCase().includes(searchTerm);
                
                // Date filter
                let matchesDate = true;
                if (fromDate || toDate) {
                    const recordDate = new Date(record.date);
                    
                    if (fromDate) {
                        const fromDateTime = new Date(fromDate);
                        matchesDate = matchesDate && recordDate >= fromDateTime;
                    }
                    
                    if (toDate) {
                        const toDateTime = new Date(toDate);
                        toDateTime.setHours(23, 59, 59, 999); // Include the entire end date
                        matchesDate = matchesDate && recordDate <= toDateTime;
                    }
                }
                
                return matchesSearch && matchesDate;
            });
            
            displayRecords(filteredRecords);
        }

        // Clear date filter
        function clearDateFilter() {
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            filterRecords();
        }

        // Set today filter
        function setTodayFilter() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fromDate').value = today;
            document.getElementById('toDate').value = today;
            filterRecords();
        }

        // Set this week filter
        function setThisWeekFilter() {
            const today = new Date();
            const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
            const lastDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            
            document.getElementById('fromDate').value = firstDayOfWeek.toISOString().split('T')[0];
            document.getElementById('toDate').value = lastDayOfWeek.toISOString().split('T')[0];
            filterRecords();
        }

        // Set this month filter
        function setThisMonthFilter() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('fromDate').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('toDate').value = lastDayOfMonth.toISOString().split('T')[0];
            filterRecords();
        }

        // Convert number to words
        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const thousands = ['', 'Thousand', 'Million', 'Billion'];

            if (num === 0) return 'Zero';

            function convertHundreds(n) {
                let result = '';
                if (n >= 100) {
                    result += ones[Math.floor(n / 100)] + ' Hundred ';
                    n %= 100;
                }
                if (n >= 20) {
                    result += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                } else if (n >= 10) {
                    result += teens[n - 10] + ' ';
                    return result;
                }
                if (n > 0) {
                    result += ones[n] + ' ';
                }
                return result;
            }

            let result = '';
            let thousandIndex = 0;
            
            while (num > 0) {
                if (num % 1000 !== 0) {
                    result = convertHundreds(num % 1000) + thousands[thousandIndex] + ' ' + result;
                }
                num = Math.floor(num / 1000);
                thousandIndex++;
            }
            
            return result.trim();
        }

        // Print document
        function printDocument(recordId, type) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;
            
            if (type === 'challan') {
                // Print challan with First Copy and Second Copy
                printChallanCopies(record);
            } else {
                // Print single bill
                printSingleDocument(record, type);
            }
        }

        function printChallanCopies(record) {
            const printContainer = document.getElementById('printTemplate');
            const originalTemplate = printContainer.innerHTML;
            
            // Create two copies
            const firstCopy = createChallanCopy(record, 'Challan - First Copy');
            const secondCopy = createChallanCopy(record, 'Challan - Second Copy');
            
            // Try to fit both on one page, otherwise use two pages
            printContainer.innerHTML = `
                <div style="page-break-after: avoid;">
                    ${firstCopy}
                </div>
                <div style="page-break-before: auto; margin-top: 20px;">
                    ${secondCopy}
                </div>
            `;
            
            printContainer.style.display = 'block';
            window.print();
            printContainer.style.display = 'none';
            
            // Restore original template
            printContainer.innerHTML = originalTemplate;
        }

        function createChallanCopy(record, title) {
            const itemsRows = record.items.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.orderNo || ''}</td>
                    <td>${item.colour || ''}</td>
                    <td>${item.measurement || ''}</td>
                    <td>${item.process || ''}</td>
                    <td>${item.uom || ''}</td>
                    <td>${item.kg || ''}</td>
                    <td>${item.yds || ''}</td>
                    <td>${item.bag || ''}</td>
                    <td>${item.remarks || ''}</td>
                </tr>
            `).join('');
            
            // FIXED: Calculate totals for challan and create footer HTML
            let totalKg = 0;
            let totalYds = 0;
            record.items.forEach(item => {
                totalKg += parseFloat(item.kg) || 0;
                totalYds += parseFloat(item.yds) || 0;
            });

            const footerHtml = `
            <tfoot>
                <tr style="font-weight: bold; background-color: #f0f0f0;">
                    <td style="border: 1px solid #333; padding: 6px; text-align: center;" colspan="6">GRAND TOTAL</td>
                    <td style="border: 1px solid #333; padding: 6px;">${totalKg.toFixed(2)}</td>
                    <td style="border: 1px solid #333; padding: 6px;">${totalYds.toFixed(2)}</td>
                    <td style="border: 1px solid #333; padding: 6px;"></td>
                    <td style="border: 1px solid #333; padding: 6px;"></td>
                </tr>
            </tfoot>
            `;

            return `
                <div style="background: white; padding: 20px; margin: 0; border: 1px solid #333; font-family: Times New Roman, sans-serif; font-size: 14px; min-height: 400px;">
                    <div style="text-align: center; padding-bottom: 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <img src="https://logic.gmsbd.com/platform/file_upload/company_details_1_5639_0.jpg" alt="Company Logo" style="max-width: 80px; height: auto; margin: 0;">
                            <div style="text-align: left;">
                                <h2 style="margin: 0; font-size: 20px;">GMS COMPOSITE KNITTING IND LTD</h2>
                                <p style="margin: 5px 0 0 0; font-size: 14px;">Sardagonj, Kashimpur, Gazipur</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="font-size: 18px; font-weight: bold; text-decoration: underline; margin: 15px 0; text-align: center;">${title}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0; font-size: 13px;">
                        <div>
                            <p style="margin: 5px 0;"><strong>Challan No:</strong> ${record.challanNumber}</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date(record.date).toLocaleDateString()}</p>
                            <p style="margin: 5px 0;"><strong>Department:</strong> ${record.department || ''}</p>
                        </div>
                        <div>
                            <p style="margin: 5px 0;"><strong>Party:</strong> ${record.partyName}</p>
                            <p style="margin: 5px 0;"><strong>Location:</strong> ${record.location || ''}</p>
                            <p style="margin: 5px 0;"><strong>Address:</strong> ${record.address || ''}</p>
                        </div>
                        <div>
                            <p style="margin: 5px 0;"><strong>Gate Pass No:</strong> ${record.gatePassNo || ''}</p>
                            <p style="margin: 5px 0;"><strong>Transport No:</strong> ${record.transportNo || ''}</p>
                            <p style="margin: 5px 0;"><strong>Driver:</strong> ${record.driverName || ''}</p>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">SL</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">Order No</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">Colour</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">Measurement</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">Process</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">UoM</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">Kg</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">Yds</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">Bag</th>
                                <th style="border: 1px solid #333; padding: 8px; background-color: #f0f0f0; font-weight: bold;">Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsRows.replace(/td>/g, 'td style="border: 1px solid #333; padding: 6px; text-align: left;">')}
                        </tbody>
                        ${footerHtml}
                    </table>
                    
                    <div style="font-size: 12px; margin: 15px 0;">
                        <p style="margin: 5px 0;"><strong>Item Description:</strong> ${record.itemDescription || ''}</p>
                        <p style="margin: 5px 0;"><strong>Challan Details:</strong> ${record.challanDetails || ''}</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 30px; padding-top: 15px;">
                        <div style="text-align: center; width: 18%;">
                            <div style="margin-top: 40px; font-size: 11px; padding-top: 8px; border-top: 1px solid #333;">Prepared by</div>
                        </div>
                        <div style="text-align: center; width: 18%;">
                            <div style="margin-top: 40px; font-size: 11px; padding-top: 8px; border-top: 1px solid #333;">Receiver's Signature</div>
                        </div>
                        <div style="text-align: center; width: 18%;">
                            <div style="margin-top: 40px; font-size: 11px; padding-top: 8px; border-top: 1px solid #333;">Checked by</div>
                        </div>
                        <div style="text-align: center; width: 18%;">
                            <div style="margin-top: 40px; font-size: 11px; padding-top: 8px; border-top: 1px solid #333;">AGM Inventory</div>
                        </div>
                        <div style="text-align: center; width: 18%;">
                            <div style="margin-top: 40px; font-size: 11px; padding-top: 8px; border-top: 1px solid #333;">Approved by</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function printSingleDocument(record, type) {
            // Populate print template for bill
            document.getElementById('printDocumentTitle').textContent = type.toUpperCase();
            document.getElementById('printChallanNo').textContent = record.challanNumber;
            document.getElementById('printBillNo').textContent = record.billNumber;
            document.getElementById('printDate').textContent = new Date(record.date).toLocaleDateString();
            document.getElementById('printPartyName').textContent = record.partyName;
            document.getElementById('printLocation').textContent = record.location || '';
            document.getElementById('printAddress').textContent = record.address || '';
            document.getElementById('printGatePassNo').textContent = record.gatePassNo || '';
            document.getElementById('printTransportNo').textContent = record.transportNo || '';
            document.getElementById('printDriverName').textContent = record.driverName || '';
            document.getElementById('printDepartment').textContent = record.department || '';
            document.getElementById('printCurrency').textContent = record.currency;
            document.getElementById('printItemDescription').textContent = record.itemDescription || '';
            document.getElementById('printChallanDetails').textContent = record.challanDetails || '';
            
            // Populate items table
            const tbody = document.getElementById('printItemsTableBody');
            tbody.innerHTML = record.items.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.orderNo || ''}</td>
                    <td>${item.colour || ''}</td>
                    <td>${item.measurement || ''}</td>
                    <td>${item.process || ''}</td>
                    <td>${item.uom || ''}</td>
                    <td>${item.kg || ''}</td>
                    <td>${item.yds || ''}</td>
                    <td>${item.bag || ''}</td>
                    <td class="rate-amount-col">${item.rate || ''}</td>
                    <td class="rate-amount-col">${item.amount || ''}</td>
                    <td class="rate-amount-col">${item.currency || 'USD'}</td>
                    <td>${item.remarks || ''}</td>
                </tr>
            `).join('');

            // FIXED: Calculate and populate footer for the bill
            let totalKg = 0;
            let totalYds = 0;
            record.items.forEach(item => {
                totalKg += parseFloat(item.kg) || 0;
                totalYds += parseFloat(item.yds) || 0;
            });
            document.getElementById('printTotalKg').textContent = totalKg.toFixed(2);
            document.getElementById('printTotalYds').textContent = totalYds.toFixed(2);
            document.getElementById('printGrandTotalAmount').textContent = `${record.currency === 'USD' ? '$' : '৳'}${record.totalAmount}`;
            
            const currencySymbol = record.currency === 'USD' ? '$' : '৳';
            const currencyName = record.currency === 'USD' ? 'Dollars' : 'Taka';
            const totalAmount = parseFloat(record.totalAmount);
            const amountInWords = numberToWords(Math.floor(totalAmount)) + ' ' + currencyName;
            
            document.getElementById('printTotalAmount').textContent = `${currencySymbol}${record.totalAmount}`;
            document.getElementById('printAmountInWords').textContent = amountInWords;
            
            // Show rate and amount columns for bill
            const rateAmountCols = document.querySelectorAll('.rate-amount-col');
            rateAmountCols.forEach(col => {
                col.style.display = 'table-cell';
            });
            
            // Show amount in words section for bill
            document.getElementById('amountInWordsSection').style.display = 'block';

            // FIXED: Hide the old total amount paragraph since it's now in the table footer
            const oldTotalAmountP = document.querySelector('#printTemplate .rate-amount-col strong').parentElement;
            oldTotalAmountP.style.display = 'none';
            
            // Show print template and print
            document.getElementById('printTemplate').style.display = 'block';
            window.print();
            document.getElementById('printTemplate').style.display = 'none';

            // FIXED: Restore the display of the old total amount paragraph
            oldTotalAmountP.style.display = 'block';
        }

        // Edit record function
        function editRecord(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;
            
            editingRecordId = recordId;
            
            // Switch to challan page
            showPage('challan');
            
            // Update page title and button text
            document.querySelector('#challan h1').textContent = 'Edit Challan & Bill';
            document.querySelector('button[type="submit"]').textContent = 'Update Challan & Bill';
            
            // Fill form with existing data
            document.getElementById('challanDate').value = record.date;
            document.getElementById('department').value = record.department || '';
            document.getElementById('partyName').value = record.partyName;
            document.getElementById('location').value = record.location || '';
            document.getElementById('address').value = record.address || '';
            document.getElementById('gatePassNo').value = record.gatePassNo || '';
            document.getElementById('transportNo').value = record.transportNo || '';
            document.getElementById('driverName').value = record.driverName || '';
            document.getElementById('itemDescription').value = record.itemDescription || '';
            document.getElementById('challanDetails').value = record.challanDetails || '';
            document.getElementById('currencySelect').value = record.currency;
            
            // Update currency symbol
            updateCurrency();
            
            // Update challan and bill numbers display
            document.getElementById('currentChallanNo').textContent = record.challanNumber;
            document.getElementById('currentBillNo').textContent = record.billNumber;
            
            // Clear existing table rows
            const tableBody = document.getElementById('itemsTableBody');
            tableBody.innerHTML = '';
            
            // Add rows with existing data
            record.items.forEach((item, index) => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" class="w3-input w3-border" placeholder="Order No" value="${item.orderNo || ''}"></td>
                    <td><input type="text" class="w3-input w3-border" placeholder="Colour" value="${item.colour || ''}"></td>
                    <td><input type="text" class="w3-input w3-border" placeholder="Measurement" value="${item.measurement || ''}"></td>
                    <td><input type="text" class="w3-input w3-border" placeholder="Process" value="${item.process || ''}"></td>
                    <td>
                        <select class="w3-select w3-border uom-select" onchange="calculateAmount(this)">
                            <option value="">Select UoM</option>
                            <option value="kg" ${item.uom === 'kg' ? 'selected' : ''}>Kg</option>
                            <option value="yds" ${item.uom === 'yds' ? 'selected' : ''}>Yds</option>
                            <option value="sample" ${item.uom === 'sample' ? 'selected' : ''}>Sample</option>
                            <option value="pcs" ${item.uom === 'pcs' ? 'selected' : ''}>Pcs</option>
                            <option value="mtr" ${item.uom === 'mtr' ? 'selected' : ''}>Mtr</option>
                        </select>
                    </td>
                    <td><input type="number" step="0.01" class="w3-input w3-border kg-input" placeholder="0.00" value="${item.kg || ''}" onchange="calculateAmount(this)"></td>
                    <td><input type="number" step="0.01" class="w3-input w3-border yds-input" placeholder="0.00" value="${item.yds || ''}" onchange="calculateAmount(this)"></td>
                    <td><input type="number" class="w3-input w3-border bag-input" placeholder="0" value="${item.bag || ''}" onchange="calculateAmount(this)"></td>
                    <td><input type="number" step="0.01" class="w3-input w3-border rate-input" placeholder="0.00" value="${item.rate || ''}" onchange="calculateAmount(this)"></td>
                    <td><input type="number" step="0.01" class="w3-input w3-border amount-input" placeholder="0.00" value="${item.amount || ''}" readonly></td>
                    <td>
                        <select class="w3-select w3-border currency-select" onchange="updateRowCurrency(this)">
                            <option value="USD" ${item.currency === 'USD' ? 'selected' : ''}>USD ($)</option>
                            <option value="BDT" ${item.currency === 'BDT' ? 'selected' : ''}>BDT (৳)</option>
                        </select>
                    </td>
                    <td><input type="text" class="w3-input w3-border remarks-input" placeholder="Enter remarks" value="${item.remarks || ''}"></td>
                    <td><button type="button" class="w3-button w3-red w3-small" onclick="removeRow(this)">Remove</button></td>
                `;
                tableBody.appendChild(newRow);
            });
            
            rowCounter = record.items.length;
            calculateTotal();
            
            // Add cancel edit button
            const formButtons = document.querySelector('#challan .w3-margin-top');
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'w3-button w3-red w3-round w3-padding-large w3-hover-light-red w3-margin-left';
                cancelBtn.textContent = 'Cancel Edit';
                cancelBtn.onclick = cancelEdit;
                formButtons.appendChild(cancelBtn);
            }
        }

        // Cancel edit function
        function cancelEdit() {
            editingRecordId = null;
            document.querySelector('#challan h1').textContent = 'Create New Challan';
            document.querySelector('button[type="submit"]').textContent = 'Create Challan & Bill';
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            resetForm();
            generateUniqueNumbers();
        }

        // Handle form submission
        async function handleChallanSubmit(event) {
            event.preventDefault();
            
            // Collect form data
            const formData = {
                challanNumber: editingRecordId ? document.getElementById('currentChallanNo').textContent : currentChallanNumber,
                billNumber: editingRecordId ? document.getElementById('currentBillNo').textContent : currentBillNumber,
                date: document.getElementById('challanDate').value,
                department: document.getElementById('department').value,
                currency: document.getElementById('currencySelect').value,
                partyName: document.getElementById('partyName').value,
                location: document.getElementById('location').value,
                address: document.getElementById('address').value,
                gatePassNo: document.getElementById('gatePassNo').value,
                transportNo: document.getElementById('transportNo').value,
                driverName: document.getElementById('driverName').value,
                itemDescription: document.getElementById('itemDescription').value,
                challanDetails: document.getElementById('challanDetails').value,
                totalAmount: document.getElementById('totalAmount').textContent,
                items: [],
                createdAt: editingRecordId ? allRecords.find(r => r.id === editingRecordId).createdAt : new Date().toISOString(),
                updatedAt: editingRecordId ? new Date().toISOString() : undefined
            };
            
            // Collect items data
            const rows = document.querySelectorAll('#itemsTableBody tr');
            rows.forEach(row => {
                const item = {
                    orderNo: row.cells[1].querySelector('input').value,
                    colour: row.cells[2].querySelector('input').value,
                    measurement: row.cells[3].querySelector('input').value,
                    process: row.cells[4].querySelector('input').value,
                    uom: row.cells[5].querySelector('select').value,
                    kg: row.cells[6].querySelector('input').value,
                    yds: row.cells[7].querySelector('input').value,
                    bag: row.cells[8].querySelector('input').value,
                    rate: row.cells[9].querySelector('input').value,
                    amount: row.cells[10].querySelector('input').value,
                    currency: row.cells[11].querySelector('select').value,
                    remarks: row.cells[12].querySelector('input').value
                };
                formData.items.push(item);
            });
            
            let saved = false;
            
            if (editingRecordId) {
                // Update existing record
                saved = await updateRecord(editingRecordId, formData);
                if (saved) {
                    alert('Challan and Bill updated successfully! ✅\n\nChallan No: ' + formData.challanNumber + '\nBill No: ' + formData.billNumber);
                    cancelEdit();
                    loadRecords();
                }
            } else {
                // Create new record
                saved = await saveToFirebase(formData);
                if (saved) {
                    alert('Challan and Bill created successfully! 🎉\n\nChallan No: ' + currentChallanNumber + '\nBill No: ' + currentBillNumber);
                    resetForm();
                    generateUniqueNumbers();
                    loadRecords();
                }
            }
            
            if (!saved) {
                alert('Error saving data. Please try again.');
            }
        }

        // Navigation functions
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-section');
            pages.forEach(page => page.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('w3-blue'));
            
            // Find the correct nav button to highlight
            const navButtons = document.querySelectorAll('.nav-link');
            navButtons.forEach(button => {
                if ((pageId === 'home' && button.textContent.includes('Home')) ||
                    (pageId === 'challan' && button.textContent.includes('Create Challan')) ||
                    (pageId === 'recent' && button.textContent.includes('Recent Challans'))) {
                    button.classList.add('w3-blue');
                }
            });
        }

        // Table management functions
        function addNewRow() {
            rowCounter++;
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${rowCounter}</td>
                <td><input type="text" class="w3-input w3-border" placeholder="Order No"></td>
                <td><input type="text" class="w3-input w3-border" placeholder="Colour"></td>
                <td><input type="text" class="w3-input w3-border" placeholder="Measurement"></td>
                <td><input type="text" class="w3-input w3-border" placeholder="Process"></td>
                <td>
                    <select class="w3-select w3-border uom-select" onchange="calculateAmount(this)">
                        <option value="">Select UoM</option>
                        <option value="kg">Kg</option>
                        <option value="yds">Yds</option>
                        <option value="sample">Sample</option>
                        <option value="pcs">Pcs</option>
                        <option value="mtr">Mtr</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" class="w3-input w3-border kg-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                <td><input type="number" step="0.01" class="w3-input w3-border yds-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                <td><input type="number" class="w3-input w3-border bag-input" placeholder="0" onchange="calculateAmount(this)"></td>
                <td><input type="number" step="0.01" class="w3-input w3-border rate-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                <td><input type="number" step="0.01" class="w3-input w3-border amount-input" placeholder="0.00" readonly></td>
                <td>
                    <select class="w3-select w3-border currency-select" onchange="updateRowCurrency(this)">
                        <option value="USD">USD ($)</option>
                        <option value="BDT">BDT (৳)</option>
                    </select>
                </td>
                <td><input type="text" class="w3-input w3-border remarks-input" placeholder="Enter remarks"></td>
                <td><button type="button" class="w3-button w3-red w3-small" onclick="removeRow(this)">Remove</button></td>
            `;
            tableBody.appendChild(newRow);
        }

        function removeRow(button) {
            const row = button.closest('tr');
            row.remove();
            updateRowNumbers();
            calculateTotal();
        }

        function updateRowNumbers() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
            rowCounter = rows.length;
        }

        function calculateAmount(input) {
            const row = input.closest('tr');
            const uom = row.querySelector('.uom-select').value;
            const kg = parseFloat(row.querySelector('.kg-input').value) || 0;
            const yds = parseFloat(row.querySelector('.yds-input').value) || 0;
            const bag = parseFloat(row.querySelector('.bag-input').value) || 0;
            const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
            
            let amount = 0;
            
            if (uom === 'kg') {
                amount = kg * rate;
            } else if (uom === 'yds') {
                amount = yds * rate;
            } else if (uom === 'sample') {
                amount = rate;
            } else {
                const totalQuantity = kg + yds + bag;
                amount = totalQuantity * rate;
            }
            
            row.querySelector('.amount-input').value = amount.toFixed(2);
            calculateTotal();
        }

        function calculateTotal() {
            const amountInputs = document.querySelectorAll('.amount-input');
            const kgInputs = document.querySelectorAll('.kg-input');
            const ydsInputs = document.querySelectorAll('.yds-input');
            
            let totalAmount = 0;
            let totalKg = 0;
            let totalYds = 0;
            
            amountInputs.forEach(input => {
                totalAmount += parseFloat(input.value) || 0;
            });
            
            kgInputs.forEach(input => {
                totalKg += parseFloat(input.value) || 0;
            });
            
            ydsInputs.forEach(input => {
                totalYds += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            document.getElementById('totalKg').textContent = totalKg.toFixed(2);
            document.getElementById('totalYds').textContent = totalYds.toFixed(2);
        }

        function updateCurrency() {
            const currencySelect = document.getElementById('currencySelect');
            const currencySymbol = document.getElementById('currencySymbol');
            
            if (currencySelect.value === 'USD') {
                currencySymbol.textContent = '$';
            } else if (currencySelect.value === 'BDT') {
                currencySymbol.textContent = '৳';
            }
        }

        function updateRowCurrency(select) {
            // This function can be used for individual row currency handling if needed
            calculateTotal();
        }

        // Export to Excel function
        function exportToExcel() {
            if (filteredRecords.length === 0) {
                alert('কোন রেকর্ড পাওয়া যায়নি! প্রথমে কিছু ডেটা ফিল্টার করুন।');
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // === DETAILED ITEMS SHEET ONLY ===
            const detailsData = [
                [''], // Empty row for spacing
                ['GMS COMPOSITE KNITTING IND LTD'],
                ['Sardagonj, Kashimpur, Gazipur'],
                ['Phone: +880-2-9291234 | Email: info@gmsbd.com'],
                [''],
                ['📋 DETAILED ITEMS REPORT'],
                [''],
                ['Report Generated:', new Date().toLocaleDateString('en-GB') + ' at ' + new Date().toLocaleTimeString()],
                ['Total Records:', filteredRecords.length],
                ['Date Filter:', (document.getElementById('fromDate').value || 'All') + ' to ' + (document.getElementById('toDate').value || 'All')],
                [''],
                ['Challan No', 'Bill No', 'Party Name', 'Date', 'SL', 'Order No', 'Colour', 'Measurement', 'Process', 'UoM', 'Kg', 'Yds', 'Bag', 'Rate', 'Amount', 'Currency', 'Remarks']
            ];
            
            // Add detailed items data
            filteredRecords.forEach(record => {
                if (record.items && record.items.length > 0) {
                    record.items.forEach((item, index) => {
                        detailsData.push([
                            record.challanNumber,
                            record.billNumber,
                            record.partyName,
                            new Date(record.date).toLocaleDateString('en-GB'),
                            index + 1,
                            item.orderNo || '-',
                            item.colour || '-',
                            item.measurement || '-',
                            item.process || '-',
                            item.uom || '-',
                            item.kg ? parseFloat(item.kg).toFixed(2) : '-',
                            item.yds ? parseFloat(item.yds).toFixed(2) : '-',
                            item.bag || '-',
                            item.rate ? parseFloat(item.rate).toFixed(2) : '-',
                            item.amount ? parseFloat(item.amount).toFixed(2) : '-',
                            item.currency || record.currency,
                            item.remarks || '-'
                        ]);
                    });
                } else {
                    detailsData.push([
                        record.challanNumber,
                        record.billNumber,
                        record.partyName,
                        new Date(record.date).toLocaleDateString('en-GB'),
                        '-',
                        '-',
                        '-',
                        '-',
                        '-',
                        '-',
                        '-',
                        '-',
                        '-',
                        '-',
                        '-',
                        record.currency,
                        'No items found'
                    ]);
                }
            });
            
            const detailsWs = XLSX.utils.aoa_to_sheet(detailsData);
            
            // Apply beautiful styling to Details Sheet
            const range = XLSX.utils.decode_range(detailsWs['!ref']);
            
            // Company header styling (Row 2)
            detailsWs['B2'] = { 
                v: 'GMS COMPOSITE KNITTING IND LTD', 
                t: 's', 
                s: { 
                    font: { bold: true, sz: 18, color: { rgb: "FFFFFF" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    fill: { fgColor: { rgb: "1F4E79" } },
                    border: {
                        top: { style: "thick", color: { rgb: "1F4E79" } },
                        bottom: { style: "thick", color: { rgb: "1F4E79" } },
                        left: { style: "thick", color: { rgb: "1F4E79" } },
                        right: { style: "thick", color: { rgb: "1F4E79" } }
                    }
                }
            };
            
            // Company address (Row 3)
            detailsWs['B3'] = { 
                v: 'Sardagonj, Kashimpur, Gazipur', 
                t: 's', 
                s: { 
                    font: { sz: 12, color: { rgb: "1F4E79" } },
                    alignment: { horizontal: "center" },
                    fill: { fgColor: { rgb: "E7F3FF" } },
                    border: {
                        top: { style: "thin", color: { rgb: "1F4E79" } },
                        bottom: { style: "thin", color: { rgb: "1F4E79" } },
                        left: { style: "thin", color: { rgb: "1F4E79" } },
                        right: { style: "thin", color: { rgb: "1F4E79" } }
                    }
                }
            };
            
            // Contact info (Row 4)
            detailsWs['B4'] = { 
                v: 'Phone: +880-2-9291234 | Email: info@gmsbd.com', 
                t: 's', 
                s: { 
                    font: { sz: 10, color: { rgb: "666666" } },
                    alignment: { horizontal: "center" },
                    fill: { fgColor: { rgb: "F8F9FA" } },
                    border: {
                        top: { style: "thin", color: { rgb: "CCCCCC" } },
                        bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                        left: { style: "thin", color: { rgb: "CCCCCC" } },
                        right: { style: "thin", color: { rgb: "CCCCCC" } }
                    }
                }
            };
            
            // Report title (Row 6)
            detailsWs['B6'] = { 
                v: '📋 DETAILED ITEMS REPORT', 
                t: 's', 
                s: { 
                    font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    fill: { fgColor: { rgb: "C55A11" } },
                    border: {
                        top: { style: "thick", color: { rgb: "C55A11" } },
                        bottom: { style: "thick", color: { rgb: "C55A11" } },
                        left: { style: "thick", color: { rgb: "C55A11" } },
                        right: { style: "thick", color: { rgb: "C55A11" } }
                    }
                }
            };
            
            // Header row styling (row 12 - index 11)
            for (let col = 0; col <= 16; col++) {
                const cellRef = XLSX.utils.encode_cell({ r: 11, c: col });
                if (detailsWs[cellRef]) {
                    detailsWs[cellRef].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" }, sz: 11 },
                        fill: { fgColor: { rgb: "4472C4" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: {
                            top: { style: "thick", color: { rgb: "000000" } },
                            bottom: { style: "thick", color: { rgb: "000000" } },
                            left: { style: "thick", color: { rgb: "000000" } },
                            right: { style: "thick", color: { rgb: "000000" } }
                        }
                    };
                }
            }
            
            // Data rows styling with alternating colors and proper borders
            const totalDetailRows = detailsData.length - 12;
            for (let row = 12; row < 12 + totalDetailRows; row++) {
                const isEvenRow = (row - 12) % 2 === 0;
                for (let col = 0; col <= 16; col++) {
                    const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
                    if (detailsWs[cellRef]) {
                        detailsWs[cellRef].s = {
                            fill: { fgColor: { rgb: isEvenRow ? "E8F4FD" : "FFFFFF" } },
                            border: {
                                top: { style: "thin", color: { rgb: "4472C4" } },
                                bottom: { style: "thin", color: { rgb: "4472C4" } },
                                left: { style: "thin", color: { rgb: "4472C4" } },
                                right: { style: "thin", color: { rgb: "4472C4" } }
                            },
                            alignment: { 
                                horizontal: [10, 11, 13, 14].includes(col) ? "right" : "left",
                                vertical: "center"
                            },
                            font: { sz: 10, color: { rgb: "333333" } }
                        };
                    }
                }
            }
            
            // Set column widths for better appearance
            detailsWs['!cols'] = [
                { wch: 15 }, // Challan No
                { wch: 15 }, // Bill No
                { wch: 25 }, // Party Name
                { wch: 12 }, // Date
                { wch: 5 },  // SL
                { wch: 15 }, // Order No
                { wch: 15 }, // Colour
                { wch: 15 }, // Measurement
                { wch: 15 }, // Process
                { wch: 8 },  // UoM
                { wch: 10 }, // Kg
                { wch: 10 }, // Yds
                { wch: 8 },  // Bag
                { wch: 10 }, // Rate
                { wch: 12 }, // Amount
                { wch: 8 },  // Currency
                { wch: 20 }  // Remarks
            ];
            
            // Merge cells for headers
            detailsWs['!merges'] = [
                { s: { r: 1, c: 1 }, e: { r: 1, c: 16 } }, // Company name
                { s: { r: 2, c: 1 }, e: { r: 2, c: 16 } }, // Address
                { s: { r: 3, c: 1 }, e: { r: 3, c: 16 } }, // Contact
                { s: { r: 5, c: 1 }, e: { r: 5, c: 16 } }  // Report title
            ];
            
            XLSX.utils.book_append_sheet(wb, detailsWs, 'Detailed Report');

            // Save the file
            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `GMS_Challan_Report_${today}.xlsx`);
        }
        
        function resetForm() {
            // Reset form fields
            document.querySelector('#challan form').reset();
            
            // Reset table
            const tableBody = document.getElementById('itemsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td>1</td>
                    <td><input type="text" class="w3-input w3-border" placeholder="Order No"></td>
                    <td><input type="text" class="w3-input w3-border" placeholder="Colour"></td>
                    <td><input type="text" class="w3-input w3-border" placeholder="Measurement"></td>
                    <td><input type="text" class="w3-input w3-border" placeholder="Process"></td>
                    <td>
                        <select class="w3-select w3-border uom-select" onchange="calculateAmount(this)">
                            <option value="">Select UoM</option>
                            <option value="kg">Kg</option>
                            <option value="yds">Yds</option>
                            <option value="sample">Sample</option>
                            <option value="pcs">Pcs</option>
                            <option value="mtr">Mtr</option>
                        </select>
                    </td>
                    <td><input type="number" step="0.01" class="w3-input w3-border kg-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                    <td><input type="number" step="0.01" class="w3-input w3-border yds-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                    <td><input type="number" class="w3-input w3-border bag-input" placeholder="0" onchange="calculateAmount(this)"></td>
                    <td><input type="number" step="0.01" class="w3-input w3-border rate-input" placeholder="0.00" onchange="calculateAmount(this)"></td>
                    <td><input type="number" step="0.01" class="w3-input w3-border amount-input" placeholder="0.00" readonly></td>
                    <td>
                        <select class="w3-select w3-border currency-select" onchange="updateRowCurrency(this)">
                            <option value="USD">USD ($)</option>
                            <option value="BDT">BDT (৳)</option>
                        </select>
                    </td>
                    <td><input type="text" class="w3-input w3-border remarks-input" placeholder="Enter remarks"></td>
                    <td><button type="button" class="w3-button w3-red w3-small" onclick="removeRow(this)">Remove</button></td>
                </tr>
            `;
            rowCounter = 1;
            
            // Reset totals
            calculateTotal();
            
            // Set current date
            setCurrentDate();
            
            // If in edit mode, cancel it
            if (editingRecordId) {
                cancelEdit();
            }
        }
    </script>
</body>
</html>
    
  </body>
  
</html>
