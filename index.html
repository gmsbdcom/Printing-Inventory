<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Untitled</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login - Access Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .login-container {
            background: linear-gradient(135deg, #619b8a 0%, #52796f 100%);
            min-height: 100vh;
        }
        
        .login-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .input-group {
            position: relative;
        }
        
        .input-field {
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(97, 155, 138, 0.2);
        }
        
        .login-btn {
            background: linear-gradient(135deg, #619b8a 0%, #52796f 100%);
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(97, 155, 138, 0.4);
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #619b8a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media print { .no-print { display: none !important; } }

        /* Dark Mode Styles - Complete Black Theme */
        .dark-mode {
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #222222;
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --border-color: #333333;
            --accent-color: #ffffff;
        }

        .dark-mode * {
            color: #ffffff !important;
        }

        .dark-mode body {
            background: #000000 !important;
            color: #ffffff !important;
        }

        .dark-mode #dataEntryContainer {
            background: #000000 !important;
        }

        .dark-mode .p-8 {
            background: #111111 !important;
            border-color: #333333 !important;
        }

        .dark-mode .text-2xl, .dark-mode .text-3xl {
            color: #ffffff !important;
            background: none !important;
            -webkit-background-clip: unset !important;
            background-clip: unset !important;
        }

        .dark-mode .text-base, .dark-mode .text-lg {
            color: #ffffff !important;
        }

        .dark-mode .text-slate-700, .dark-mode .text-slate-900, 
        .dark-mode .text-blue-600, .dark-mode .text-blue-700,
        .dark-mode .text-green-600, .dark-mode .text-purple-600,
        .dark-mode .text-orange-600, .dark-mode .text-amber-600,
        .dark-mode .text-indigo-600, .dark-mode .text-emerald-600 {
            color: #ffffff !important;
        }

        .dark-mode .bg-gradient-to-br, .dark-mode .bg-gradient-to-r {
            background: #111111 !important;
        }

        .dark-mode .bg-gradient-to-r.from-indigo-50,
        .dark-mode .bg-gradient-to-r.from-slate-100,
        .dark-mode .bg-gradient-to-r.from-slate-50 {
            background: #111111 !important;
        }

        .dark-mode .border-blue-200, .dark-mode .border-indigo-200,
        .dark-mode .border-2 {
            border-color: #333333 !important;
        }

        .dark-mode input, .dark-mode select {
            background: #222222 !important;
            border-color: #333333 !important;
            color: #ffffff !important;
        }

        .dark-mode input:focus, .dark-mode select:focus {
            border-color: #555555 !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2) !important;
        }

        .dark-mode input::placeholder {
            color: #888888 !important;
        }

        .dark-mode table {
            background: #111111 !important;
        }

        .dark-mode th {
            background: #222222 !important;
            color: #ffffff !important;
        }

        .dark-mode td {
            border-color: #333333 !important;
            color: #ffffff !important;
            background: #111111 !important;
        }

        .dark-mode .odd\\:bg-white\\/90:nth-child(odd) {
            background: #111111 !important;
        }

        .dark-mode .even\\:bg-blue-50\\/60:nth-child(even) {
            background: #1a1a1a !important;
        }

        .dark-mode .hover\\:bg-blue-100\\/50:hover {
            background: #333333 !important;
        }

        .dark-mode .company-option:hover, .dark-mode .address-option:hover, 
        .dark-mode .location-option:hover, .dark-mode .department-option:hover {
            background: #333333 !important;
            color: #ffffff !important;
        }

        .dark-mode #toDropdown, .dark-mode #addressDropdown, 
        .dark-mode #locationDropdown, .dark-mode #departmentDropdown {
            background: #222222 !important;
            border-color: #333333 !important;
        }

        .dark-mode .company-option, .dark-mode .address-option, 
        .dark-mode .location-option, .dark-mode .department-option {
            color: #ffffff !important;
            border-color: #333333 !important;
        }

        .dark-mode button {
            color: #ffffff !important;
        }

        .dark-mode svg {
            color: #ffffff !important;
        }

        .dark-mode label {
            color: #ffffff !important;
        }

        .dark-mode span {
            color: #ffffff !important;
        }

        .dark-mode div {
            color: #ffffff !important;
        }

        .dark-mode .bg-slate-50, .dark-mode .bg-slate-100,
        .dark-mode .bg-blue-50, .dark-mode .bg-indigo-50,
        .dark-mode .bg-white {
            background: #111111 !important;
        }

        .dark-mode .shadow-xl, .dark-mode .shadow-lg {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginContainer" class="login-container flex items-center justify-center p-6">
        <div class="login-card rounded-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border-2 border-gray-200">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFoZoF_UQFDZ0WIcogBokuYyvqzzKr_TMibzKjBQyPDZSXK3kc5zPUyyIqJ4_WunT8HKXEtSIE8-g_GdKl50_bbERjV-TTMl_7B7CpQJ87E-tR3XoZs9kSFwsotGIaKTQL2xOFsp9bPJOyUUOcipV9oN45FYpst4LTwEe3f84jhyKTMVulcUvNi-kRRam2/s320-rw/GMS-Composite-Knitting-Ind.-Ltd.png" alt="GMS Logo" class="w-12 h-12 object-contain rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <svg class="w-8 h-8 text-gray-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">GMS COMPOSITE KNITTING IND LTD</h1>
                <p class="text-gray-600">Enter your credentials to continue</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div class="input-group">
                    <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" name="username" required 
                           class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                           placeholder="Enter your username">
                </div>

                <div class="input-group">
                    <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" required 
                               class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none pr-12"
                               placeholder="Enter your password">
                        <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-600">Remember me</span>
                    </label>
                    <a href="#" class="text-sm text-blue-600 hover:text-blue-700 font-medium">Forgot password?</a>
                </div>

                <button type="submit" id="loginBtn" class="login-btn w-full py-3 px-4 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center">
                    <span id="loginText">Sign In</span>
                    <div id="loginSpinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">
                    Don't have an account? 
                    <a href="#" class="text-blue-600 hover:text-blue-700 font-medium">Contact Administrator</a>
                </p>
            </div>

            <div class="mt-4 text-center">
                <p class="text-xs text-gray-500">
                    Developed by: S@ju<span class="text-xs align-super">TM</span>
                </p>
            </div>

            <div id="loginError" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm hidden">
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <span id="errorMessage">Invalid credentials. Please try again.</span>
                </div>
            </div>

            <div id="loginSuccess" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm hidden">
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Login successful! Redirecting...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Entry Form -->
    <div id="dataEntryContainer" class="min-h-screen font-sans hidden" style="background: linear-gradient(180deg, #e6f0ff 0%, #ffffff 25%, #f5f5f5 100%); position: relative;">
        <!-- Enhanced textile texture overlay -->
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.04; background-image: 
            radial-gradient(circle at 2px 2px, #4f46e5 1px, transparent 1px),
            linear-gradient(45deg, transparent 40%, rgba(79,70,229,0.08) 50%, transparent 60%),
            linear-gradient(-45deg, transparent 40%, rgba(79,70,229,0.08) 50%, transparent 60%);
            background-size: 24px 24px, 48px 48px, 48px 48px;
            background-position: 0 0, 0 0, 24px 24px;
            pointer-events: none;"></div>
        <div class="w-full relative z-10">
            <div class="p-4 bg-gradient-to-br from-white/95 via-white/90 to-blue-50/80 backdrop-blur-md rounded-xl mx-3 mt-3 shadow-lg border border-white/60 ring-1 ring-blue-100/50">
                <!-- Enhanced Header with Logout -->
                <header class="flex flex-col md:flex-row items-start md:items-stretch justify-between gap-3 mb-2">
                    <div class="flex items-center gap-3">
                        <!-- Company Logo/Icon -->
                        <div class="w-12 h-12 rounded-lg flex items-center justify-center shadow-md ring-1 ring-green-200/50 bg-white">
                            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFoZoF_UQFDZ0WIcogBokuYyvqzzKr_TMibzKjBQyPDZSXK3kc5zPUyyIqJ4_WunT8HKXEtSIE8-g_GdKl50_bbERjV-TTMl_7B7CpQJ87E-tR3XoZs9kSFwsotGIaKTQL2xOFsp9bPJOyUUOcipV9oN45FYpst4LTwEe3f84jhyKTMVulcUvNi-kRRam2/s320-rw/GMS-Composite-Knitting-Ind.-Ltd.png" alt="GMS Logo" class="w-10 h-10 object-contain rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <svg class="w-6 h-6 text-gray-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="text-lg md:text-xl font-bold bg-gradient-to-r from-green-800 via-green-900 to-teal-900 bg-clip-text text-transparent" style="background: linear-gradient(to right, #52796f, #354f52, #2f3e46); -webkit-background-clip: text; background-clip: text;">GMS Composite Knitting Ind Ltd</div>
                            <div class="text-xs font-medium flex items-center gap-1 mt-0.5" style="color: #619b8a;">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Sardagonj, Kashimpur, Gazipur
                            </div>
                            <div class="text-sm mt-1 font-semibold bg-gradient-to-r bg-clip-text text-transparent" style="background: linear-gradient(to right, #52796f, #619b8a); -webkit-background-clip: text; background-clip: text;">DELIVERY CHALLAN / BILL</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="darkModeToggle" class="no-print bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white px-3 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-xs font-semibold flex items-center gap-1.5 ring-1 ring-slate-200/50">
                            <svg id="darkModeIcon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                            <span id="darkModeText">Dark</span>
                        </button>
                        <button id="logoutBtn" class="no-print bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-3 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-xs font-semibold flex items-center gap-1.5 ring-1 ring-red-200/50">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </button>
                        <div class="border border-blue-200/60 rounded-lg p-3 min-w-[280px] w-full md:w-auto bg-gradient-to-br from-white/95 to-blue-50/90 backdrop-blur-md shadow-md ring-1 ring-blue-100/50">
                            <div class="flex items-center justify-between gap-2 mb-2">
                                <label class="text-sm font-semibold text-slate-700 flex items-center gap-1.5">
                                    <svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Challan No:
                                </label>
                                <span id="challanNo" class="font-bold text-slate-900 text-sm bg-gradient-to-r from-slate-800 to-slate-900 bg-clip-text text-transparent">CH-2025-00001</span>
                            </div>
                            <div class="flex items-center justify-between gap-2 mb-3">
                                <label class="text-sm font-semibold text-slate-700 flex items-center gap-1.5">
                                    <svg class="w-3.5 h-3.5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                    Bill No:
                                </label>
                                <span id="billNo" class="font-bold text-emerald-700 text-sm bg-gradient-to-r from-emerald-700 to-emerald-800 bg-clip-text text-transparent">—</span>
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                    <svg class="w-3.5 h-3.5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    Date
                                </label>
                                <input type="date" id="date" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium"/>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Enhanced Search & Load -->
                <section class="mt-6 bg-gradient-to-r from-indigo-50/80 via-blue-50/60 to-purple-50/80 backdrop-blur-sm rounded-lg p-4 border border-indigo-200/50 shadow-md ring-1 ring-indigo-100/50">
                    <div class="grid md:grid-cols-[1fr_auto] gap-3 items-end">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-1.5">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                বিল/চালান নাম্বার সার্চ
                            </label>
                            <input id="searchNumber" type="text" placeholder="যেমন: BILL-2025-00001 বা CH-2025-00001" class="w-full border border-indigo-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium placeholder:text-slate-400"/>
                        </div>
                        <div class="flex gap-2">
                            <button id="searchBtn" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-semibold flex items-center gap-1.5 ring-1 ring-indigo-200/50">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                                লোড করুন
                            </button>
                            <button id="saveUpdatesBtn" class="bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-semibold hidden flex items-center gap-1.5 ring-1 ring-amber-200/50">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                আপডেট সংরক্ষণ
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Enhanced Meta Grid -->
                <section class="grid md:grid-cols-2 gap-4 mt-6">
                    <div class="space-y-3">
                        <div class="relative">
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                To
                            </label>
                            <input type="text" id="to" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="GMS TRIMS LTD" placeholder="Select or type company name..." autocomplete="off"/>
                            <div id="toDropdown" class="absolute z-10 w-full bg-white/98 backdrop-blur-md border-2 border-blue-200/60 rounded-xl shadow-xl max-h-48 overflow-y-auto hidden ring-1 ring-blue-100/50">
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Gms Trims Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Air Trims</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Asia Linkage</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Asr Thread & Accessories Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Blue Planet Sweater Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Db Trims Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Gazaria Elastic Industries Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Globel Premium Accessories Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">HANGZHOU SUNSHINE TRIMS</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Hernest Label Ind.Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Jist Industrien Co.Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">MACK TRIMS LTD.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Mahhdir Textiles Industries</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">MK Accessories</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">MM KNITWEAR LTD.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">PANDORA ACCESSORIES LTD.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">Papyrus FastQ (BD) Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">R.K.Garments Accessories Ind. Ltd.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">RAHIM TEXTILE MILLS LIMITED</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">STANDARD NARROW FABRICS</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">TAZRIYAN ACCESSORIES</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">The Moon Trade</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">TRIMSNET BANGLADESH</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150">URMI GARMENTS LTD.</div>
                                <div class="company-option px-4 py-3 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer font-medium transition-all duration-150">Texas Packages & Accessories Ltd.</div>
                            </div>
                        </div>
                        <div class="relative">
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Address
                            </label>
                            <input type="text" id="address" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="Sardagonj, Kashimpur, Gazipur" placeholder="Select or type address..." autocomplete="off"/>
                            <div id="addressDropdown" class="absolute z-10 w-full bg-white/98 backdrop-blur-md border border-blue-200/60 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden ring-1 ring-blue-100/50">
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Shardagonj,Kashimpur,Gazipur.</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Tongi,Gazipur</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Mirpur,Dhaka</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Mawna,Sreepur,Gazipur</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Lokhonkhola,Narayangonj.</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Kaliakoir,Gazipur</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Charbahar,Sreepur,Gazipur</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Ashulia,Savar,Dhaka</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Badda,Dhaka</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Konabari,Gazipur.</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Turag,Dhaka</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Uttara,Dhaka</div>
                                <div class="address-option px-3 py-2 hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 cursor-pointer font-medium transition-all duration-150 text-sm">Kaultia,Gazipur</div>
                            </div>
                        </div>
                        <div class="relative">
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                Location
                            </label>
                            <input type="text" id="location" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="In House" placeholder="Select or type location..." autocomplete="off"/>
                            <div id="locationDropdown" class="absolute z-10 w-full bg-white/98 backdrop-blur-md border border-blue-200/60 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden ring-1 ring-blue-100/50">
                                <div class="location-option px-3 py-2 hover:bg-gradient-to-r hover:from-purple-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">In House</div>
                                <div class="location-option px-3 py-2 hover:bg-gradient-to-r hover:from-purple-50 hover:to-blue-50 cursor-pointer font-medium transition-all duration-150 text-sm">Out Side</div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                Item Description / Elastic Type
                            </label>
                            <input type="text" id="itemDesc" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="RIBBON ELASATIC"/>
                        </div>
                        <div class="relative">
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                Department
                            </label>
                            <input type="text" id="department" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="Narrow Fabrics Dyeing" placeholder="Select or type department..." autocomplete="off"/>
                            <div id="departmentDropdown" class="absolute z-10 w-full bg-white/98 backdrop-blur-md border border-blue-200/60 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden ring-1 ring-blue-100/50">
                                <div class="department-option px-3 py-2 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Narrow Fabrics Dyeing</div>
                                <div class="department-option px-3 py-2 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-blue-50 cursor-pointer border-b border-blue-100/50 font-medium transition-all duration-150 text-sm">Washing</div>
                                <div class="department-option px-3 py-2 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-blue-50 cursor-pointer font-medium transition-all duration-150 text-sm">Dyeing</div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                                Gate Pass No
                            </label>
                            <input type="text" id="gatePass" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="115545"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2v0a2 2 0 01-2-2v-1"></path>
                                </svg>
                                Transport No
                            </label>
                            <input type="text" id="transportNo" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="DM-U-12-2500"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1.5 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Driver's Name
                            </label>
                            <input type="text" id="driver" class="w-full border border-blue-200/60 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="SALAM"/>
                        </div>
                    </div>
                </section>

                <!-- Enhanced Table -->
                <div class="mt-6 overflow-x-auto bg-gradient-to-br from-white/95 to-blue-50/80 backdrop-blur-md rounded-lg p-3 shadow-lg border border-blue-200/50 ring-1 ring-blue-100/50">
                    <table id="itemsTable" class="w-full border-collapse text-sm border border-blue-200/60 rounded-lg overflow-hidden shadow-md" style="background-color: #cad2c5;">
                        <thead>
                            <tr style="background-color: #52796f; color: white;">
                                <th class="border border-blue-300/50 p-2 text-left font-semibold text-xs">SL. NO</th>
                                <th class="border border-blue-300/50 p-2 text-left font-semibold min-w-[100px] text-xs">Order No</th>
                                <th class="border border-blue-300/50 p-2 text-left font-semibold min-w-[80px] text-xs">Colour</th>
                                <th class="border border-blue-300/50 p-2 text-left font-semibold min-w-[100px] text-xs">Measurement</th>
                                <th class="border border-blue-300/50 p-2 text-left font-semibold min-w-[100px] text-xs">Process</th>
                                <th class="border border-blue-300/50 p-2 text-center font-semibold min-w-[60px] text-xs">UoM</th>
                                <th class="border border-blue-300/50 p-2 text-center font-semibold min-w-[60px] text-xs">Kg</th>
                                <th class="border border-blue-300/50 p-2 text-center font-semibold min-w-[60px] text-xs">Yds</th>
                                <th class="border border-blue-300/50 p-2 text-center font-semibold min-w-[50px] text-xs">Bag</th>
                                <th class="border border-blue-300/50 p-2 text-center font-semibold min-w-[60px] text-xs">Rate</th>
                                <th class="border border-blue-300/50 p-2 text-center font-semibold min-w-[70px] text-xs">
                                    <div class="flex items-center justify-center gap-1">
                                        <span>Amount</span>
                                        <label class="flex items-center gap-0.5 cursor-pointer bg-white/20 rounded px-1 py-0.5 hover:bg-white/30 transition-all duration-200">
                                            <input type="checkbox" id="dollarMode" class="w-3 h-3 rounded">
                                            <span class="text-xs font-semibold text-green-300">$</span>
                                        </label>
                                    </div>
                                </th>
                                <th class="border border-blue-300/50 p-2 text-left font-semibold min-w-[100px] text-xs">Remarks</th>
                                <th class="border border-blue-300/50 p-2 text-center font-semibold min-w-[70px] text-xs">Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr class="bg-gradient-to-r from-slate-100 via-blue-50 to-indigo-50">
                                <td colspan="6" class="border border-blue-200/60 p-2 font-bold text-right text-sm text-slate-700">Total</td>
                                <td id="totalKg" class="border border-blue-200/60 p-2 text-center font-bold text-sm text-slate-700">0</td>
                                <td id="totalYds" class="border border-blue-200/60 p-2 text-center font-bold text-sm text-slate-700">0</td>
                                <td id="totalBag" class="border border-blue-200/60 p-2 text-center font-bold text-sm text-slate-700">0</td>
                                <td id="totalRate" class="border border-blue-200/60 p-2 text-center font-bold text-sm text-slate-700">—</td>
                                <td id="totalAmount" class="border border-blue-200/60 p-2 text-center font-bold text-sm text-emerald-700">0</td>
                                <td colspan="2" class="border border-blue-200/60 p-2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Enhanced Controls -->
                <div class="flex flex-wrap items-center gap-3 mt-4 p-3 bg-gradient-to-r from-slate-50/80 via-blue-50/60 to-indigo-50/80 backdrop-blur-sm rounded-lg border border-slate-200/50 shadow-md">
                    <button id="addRow" class="text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-semibold flex items-center gap-1.5 ring-1 ring-green-200/50" style="background: linear-gradient(to right, #619b8a, #52796f); &:hover { background: linear-gradient(to right, #52796f, #354f52); }">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Row
                    </button>
                    <button id="resetForm" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-semibold flex items-center gap-1.5 ring-1 ring-green-200/50">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                    <button id="saveToFirebase" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-semibold flex items-center gap-1.5 ring-1 ring-purple-200/50">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        সেভ করুন
                    </button>
                    <button id="newChallanBtn" class="bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-semibold hidden flex items-center gap-1.5 ring-1 ring-orange-200/50">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        নতুন চালান
                    </button>
                    <div class="ml-auto flex gap-2">
                        <button id="generateBill" class="bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-semibold flex items-center gap-1.5 ring-1 ring-emerald-200/50">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            বিল তৈরি করুন
                        </button>
                        <button id="generateChallan" class="bg-gradient-to-r from-sky-600 to-sky-700 hover:from-sky-700 hover:to-sky-800 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-semibold flex items-center gap-1.5 ring-1 ring-sky-200/50">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            চালান তৈরি করুন
                        </button>
                    </div>
                </div>

                <p class="text-sm text-slate-600 mt-2">Tip: "সেভ করুন" দিয়ে Firebase-এ সেভ করুন। সার্চ বক্সে নাম্বার লিখে লোড করে এডিট ও আপডেট করতে পারবেন।</p>
            </div>
        </div>

        <!-- Enhanced Toast -->
        <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gradient-to-r from-slate-800 via-slate-900 to-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl opacity-0 pointer-events-none transition-all duration-300 backdrop-blur-md border border-slate-700/50 ring-1 ring-slate-600/50 font-semibold text-base flex items-center gap-2 min-w-[200px] justify-center">
            <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Saved!</span>
        </div>
    </div>

    <script>
        // ========== LOGIN SYSTEM ==========
        // Valid credentials (in real app, this would be server-side)
        const VALID_CREDENTIALS = [
            { username: 'admin', password: 'admin123' },
            { username: 'user', password: 'user123' },
            { username: 'manager', password: 'manager123' },
            { username: 'gms', password: 'gms2025' }
        ];

        // Check if user is already logged in
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const loginContainer = document.getElementById('loginContainer');
            const dataEntryContainer = document.getElementById('dataEntryContainer');
            
            if (isLoggedIn) {
                loginContainer.classList.add('hidden');
                dataEntryContainer.classList.remove('hidden');
                initializeDataEntryForm();
            } else {
                loginContainer.classList.remove('hidden');
                dataEntryContainer.classList.add('hidden');
            }
        }

        // Initialize login system
        function initializeLoginSystem() {
            const loginForm = document.getElementById('loginForm');
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginError = document.getElementById('loginError');
            const loginSuccess = document.getElementById('loginSuccess');
            const errorMessage = document.getElementById('errorMessage');
            const logoutBtn = document.getElementById('logoutBtn');

            // Toggle password visibility
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                // Toggle eye icon
                const eyeIcon = this.querySelector('svg');
                if (type === 'text') {
                    eyeIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                    `;
                } else {
                    eyeIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    `;
                }
            });

            // Handle login form submission
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                // Hide previous messages
                loginError.classList.add('hidden');
                loginSuccess.classList.add('hidden');
                
                // Show loading state
                loginBtn.disabled = true;
                loginText.textContent = 'Signing In...';
                loginSpinner.classList.remove('hidden');
                
                // Simulate authentication delay
                setTimeout(() => {
                    // Check credentials
                    const isValid = VALID_CREDENTIALS.some(cred => 
                        cred.username === username && cred.password === password
                    );
                    
                    if (isValid) {
                        // Success animation
                        loginForm.classList.add('success-animation');
                        loginSuccess.classList.remove('hidden');
                        
                        // Store login status
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('currentUser', username);
                        if (rememberMe) {
                            localStorage.setItem('rememberLogin', 'true');
                        }
                        
                        // Redirect to main app after delay
                        setTimeout(() => {
                            document.getElementById('loginContainer').classList.add('hidden');
                            document.getElementById('dataEntryContainer').classList.remove('hidden');
                            initializeDataEntryForm();
                        }, 1500);
                        
                    } else {
                        // Error animation and message
                        loginForm.classList.add('error-shake');
                        loginError.classList.remove('hidden');
                        
                        // Try to provide specific error message
                        const userExists = VALID_CREDENTIALS.some(cred => cred.username === username);
                        if (!userExists) {
                            errorMessage.textContent = 'Username not found. Please check your username.';
                        } else {
                            errorMessage.textContent = 'Incorrect password. Please try again.';
                        }
                        
                        // Clear password field
                        document.getElementById('password').value = '';
                        
                        // Remove animation class after animation completes
                        setTimeout(() => {
                            loginForm.classList.remove('error-shake');
                        }, 500);
                    }
                    
                    // Reset button state
                    loginBtn.disabled = false;
                    loginText.textContent = 'Sign In';
                    loginSpinner.classList.add('hidden');
                }, 1200); // Simulate network delay
            });

            // Handle logout
            logoutBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    // Clear login status
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('rememberLogin');
                    
                    // Show login form
                    document.getElementById('dataEntryContainer').classList.add('hidden');
                    document.getElementById('loginContainer').classList.remove('hidden');
                    
                    // Reset login form
                    document.getElementById('loginForm').reset();
                    loginError.classList.add('hidden');
                    loginSuccess.classList.add('hidden');
                    
                    showToast('Logged out successfully');
                }
            });

            // Auto-fill remembered credentials
            if (localStorage.getItem('rememberLogin') === 'true') {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    document.getElementById('username').value = savedUser;
                    document.getElementById('rememberMe').checked = true;
                }
            }
        }

        // ========== DATA ENTRY FORM SYSTEM ==========
        // Initialize on page load
        window.addEventListener('load', function() {
            initializeLoginSystem();
            checkLoginStatus();
        });

        function initializeDataEntryForm() {
            // Set current date
            const dateEl = document.getElementById('date');
            dateEl.valueAsDate = new Date();

            // Reset form to completely fresh state
            resetToFreshState();

            // Initialize Firebase and form functionality
            initializeFirebaseSystem();
            initializeTableSystem();
            initializeDropdownSystem();
            initializeFormControls();
        }

        // নতুন ফাংশন - সম্পূর্ণ ফ্রেশ স্টেট
        function resetToFreshState() {
            // Reset all form fields to completely empty values
            $('#challanNo').textContent = 'CH-2025-00001';
            $('#billNo').textContent = '—';
            $('#to').value = '';
            $('#address').value = '';
            $('#location').value = '';
            $('#itemDesc').value = '';
            $('#department').value = '';
            $('#gatePass').value = '';
            $('#transportNo').value = '';
            $('#driver').value = '';
            
            // Reset dollar mode checkbox
            $('#dollarMode').checked = false;
            
            // Hide update buttons
            $('#saveUpdatesBtn').classList.add('hidden');
            $('#newChallanBtn').classList.add('hidden');
            
            // Clear search field
            $('#searchNumber').value = '';
            
            // Clear table (will be populated by initializeTableSystem)
            const tbody = $('#itemsTable tbody');
            tbody.innerHTML = '';
        }

        // ========== Helpers ==========
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
        const toast = document.getElementById('toast');
        let toastTimer;
        
        function showToast(msg, ok=true) {
            toast.textContent = msg;
            toast.style.background = ok ? '#0f172a' : '#b91c1c';
            toast.classList.remove('opacity-0','pointer-events-none');
            toast.classList.add('opacity-100');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(()=>toast.classList.add('opacity-0','pointer-events-none'), 1800);
        }

        // Firebase REST base (no credentials used)
        const FIREBASE_BASE = 'https://billprint-ee553-default-rtdb.firebaseio.com/';

        // ========== Firebase Counter System ==========
        function getYearFromDate(d){ const dt=new Date(d); return dt.getFullYear(); }
        
        // Get next sequence from Firebase counters (yearly counter)
        async function getNextSequence(counterType, year) {
            const counterPath = `counters/${counterType}_${year}`;
            
            try {
                // Get current counter value
                const getRes = await fetch(`${FIREBASE_BASE}${counterPath}.json`);
                let currentValue = 0;
                
                if (getRes.ok) {
                    const data = await getRes.json();
                    currentValue = data || 0;
                }
                
                // Increment counter
                const newValue = currentValue + 1;
                
                // Update counter in Firebase
                const updateRes = await fetch(`${FIREBASE_BASE}${counterPath}.json`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newValue)
                });
                
                if (!updateRes.ok) {
                    throw new Error('Counter update failed');
                }
                
                return newValue;
            } catch (error) {
                console.error('Counter error:', error);
                // Fallback to local storage if Firebase fails
                const key = `${counterType}_${year}`;
                let seq = Number(localStorage.getItem(key)||0)+1;
                localStorage.setItem(key, String(seq));
                showToast('Firebase কাউন্টার ব্যর্থ - লোকাল কাউন্টার ব্যবহার হচ্ছে', false);
                return seq;
            }
        }
        
        async function generateBillNumber(){
            const year = getYearFromDate($('#date').value || new Date());
            const seq = await getNextSequence('BILL_SEQ', year);
            
            // Handle overflow: if sequence exceeds 99999, use 6-digit format
            if (seq > 99999) {
                return `BILL-${year}-${String(seq).padStart(6,'0')}`;
            }
            return `BILL-${year}-${String(seq).padStart(5,'0')}`;
        }
        
        async function generateChallanNumber(){
            const year = getYearFromDate($('#date').value || new Date());
            const seq = await getNextSequence('CHALLAN_SEQ', year);
            
            // Handle overflow: if sequence exceeds 99999, use 6-digit format
            if (seq > 99999) {
                return `CH-${year}-${String(seq).padStart(6,'0')}`;
            }
            return `CH-${year}-${String(seq).padStart(5,'0')}`;
        }

        function initializeFirebaseSystem() {
            // Firebase system is already initialized above
        }

        // ========== Table Logic ==========
        function initializeTableSystem() {
            const tbody = $('#itemsTable tbody');
            let rowCount = 0;
            
            window.addRow = function(data = {}) {
                rowCount++;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-100/50 transition-all duration-150';
                tr.style.backgroundColor = '#cad2c5';
                tr.innerHTML = `
                    <td class="sl border border-blue-200/60 p-2 text-center font-semibold text-slate-700 text-xs" style="background-color: #cad2c5;">${rowCount}</td>
                    <td class="border border-blue-200/60 p-2" style="background-color: #cad2c5;"><input type="text" class="order w-full min-w-[80px] border border-blue-200/50 rounded px-2 py-1 text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.order ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2" style="background-color: #cad2c5;"><input type="text" class="colour w-full min-w-[60px] border border-blue-200/50 rounded px-2 py-1 text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.colour ?? 'BLACK'}"/></td>
                    <td class="border border-blue-200/60 p-2" style="background-color: #cad2c5;"><input type="text" class="measurement w-full min-w-[80px] border border-blue-200/50 rounded px-2 py-1 text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.measurement ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2" style="background-color: #cad2c5;"><input type="text" class="process w-full min-w-[80px] border border-blue-200/50 rounded px-2 py-1 text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.process ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2 text-center" style="background-color: #cad2c5;">
                        <select class="uom w-full min-w-[50px] border border-blue-200/50 rounded px-2 py-1 text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium">
                            <option value="KG">KG</option>
                            <option value="YDS">YDS</option>
                            <option value="SAMPLE">SAMPLE</option>
                        </select>
                    </td>
                    <td class="border border-blue-200/60 p-2 text-center" style="background-color: #cad2c5;"><input type="number" min="0" step="any" class="kg w-full min-w-[50px] border border-blue-200/50 rounded px-2 py-1 text-right text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.kg ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2 text-center" style="background-color: #cad2c5;"><input type="number" min="0" step="any" class="yds w-full min-w-[50px] border border-blue-200/50 rounded px-2 py-1 text-right text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.yds ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2 text-center" style="background-color: #cad2c5;"><input type="number" min="0" step="1" class="bag w-full min-w-[40px] border border-blue-200/50 rounded px-2 py-1 text-right text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.bag ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2 text-center" style="background-color: #cad2c5;"><input type="number" min="0" step="any" class="rate w-full min-w-[50px] border border-blue-200/50 rounded px-2 py-1 text-right text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.rate ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2 text-center" style="background-color: #cad2c5;"><input type="number" min="0" step="any" class="amount w-full min-w-[60px] border border-blue-200/50 rounded px-2 py-1 text-right text-xs bg-slate-100/90 backdrop-blur-sm shadow-sm transition-all duration-200 font-medium" value="${data.amount ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2" style="background-color: #cad2c5;"><input type="text" class="remarks w-full min-w-[80px] border border-blue-200/50 rounded px-2 py-1 text-xs bg-white/95 backdrop-blur-sm shadow-sm focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition-all duration-200 font-medium" value="${data.remarks ?? ''}"/></td>
                    <td class="border border-blue-200/60 p-2 text-center" style="background-color: #cad2c5;">
                        <button class="removeRow bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-2 py-1 rounded text-xs font-semibold shadow-sm hover:shadow-md transition-all duration-200 flex items-center gap-1 mx-auto">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Remove
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
                if (data.uom) tr.querySelector('.uom').value = data.uom;

                tr.querySelectorAll('input, select').forEach(el => el.addEventListener('input', updateTotals));
                tr.querySelector('.removeRow').addEventListener('click', (e) => { e.preventDefault(); removeRow(tr); });
                updateTotals();
            }
            
            function removeRow(tr){ tr.remove(); renumber(); updateTotals(); }
            function renumber(){ rowCount=0; $$('#itemsTable tbody tr').forEach(r=>{ r.querySelector('.sl').textContent = ++rowCount; }); }
            function toFixedTrim(n){ const num=Number(n||0); return num.toFixed(2); }

            window.updateTotals = function() {
                const isDollarMode = $('#dollarMode').checked;
                
                let totalKg=0, totalYds=0, totalBag=0, totalAmount=0;
                $$('#itemsTable tbody tr').forEach(tr=>{
                    const isSample = ($('.order',tr).value||'').trim().toUpperCase()==='SAMPLE';
                    const uom = $('.uom',tr).value;
                    const kg = parseFloat($('.kg',tr).value)||0;
                    const yds = parseFloat($('.yds',tr).value)||0;
                    const bag = parseInt($('.bag',tr).value)||0;
                    const rateEl = $('.rate',tr);
                    const amountEl = $('.amount',tr);
                    const rate = parseFloat(rateEl.value)||0;

                    totalKg+=kg; totalYds+=yds; totalBag+=bag;

                    if (!isSample && uom !== 'SAMPLE') {
                        let amount = 0;
                        if (uom==='KG') amount = kg*rate;
                        else if (uom==='YDS') amount = yds*rate;
                        
                        amountEl.value = amount ? toFixedTrim(amount) : '';
                        amountEl.readOnly = true;
                        amountEl.classList.add('bg-slate-50');
                    } else if (uom === 'SAMPLE') {
                        // For SAMPLE UoM, Amount = Rate (whatever user types in Rate field)
                        amountEl.value = rate ? toFixedTrim(rate) : '';
                        amountEl.readOnly = true;
                        amountEl.classList.add('bg-slate-50');
                    } else {
                        amountEl.readOnly = false;
                        amountEl.classList.remove('bg-slate-50');
                    }

                    totalAmount += parseFloat(amountEl.value)||0;
                });
                $('#totalKg').textContent = toFixedTrim(totalKg);
                $('#totalYds').textContent = toFixedTrim(totalYds);
                $('#totalBag').textContent = toFixedTrim(totalBag);
                
                // Show currency symbol in total based on mode
                const totalAmountText = isDollarMode ? `$${toFixedTrim(totalAmount)}` : `${toFixedTrim(totalAmount)} BDT`;
                $('#totalAmount').textContent = totalAmountText;
                $('#totalRate').textContent = '—';
            }

            // Add one empty row for fresh start
            addRow();
        }

        // ========== Data Collect/Fill ==========
        function collectRows(){
            const rows=[];
            $$('#itemsTable tbody tr').forEach((tr,idx)=>{
                rows.push({
                    sl: idx+1,
                    order: $('.order',tr).value.trim(),
                    colour: $('.colour',tr).value.trim(),
                    measurement: $('.measurement',tr).value.trim(),
                    process: $('.process',tr).value.trim(),
                    uom: $('.uom',tr).value,
                    kg: $('.kg',tr).value,
                    yds: $('.yds',tr).value,
                    bag: $('.bag',tr).value,
                    rate: $('.rate',tr).value,
                    amount: $('.amount',tr).value,
                    remarks: $('.remarks',tr).value.trim(),
                });
            });
            return rows;
        }
        
        function setRows(rows){
            const tbody = $('#itemsTable tbody');
            tbody.innerHTML = '';
            let rowCount = 0;
            (rows||[]).forEach(r=>addRow(r));
            if (!rows || rows.length===0) updateTotals();
        }
        
        function collectForm(){
            return {
                challanNo: $('#challanNo').textContent.trim(),
                billNo: $('#billNo').textContent.trim(),
                date: $('#date').value || new Date().toISOString().slice(0,10),
                to: $('#to').value.trim(),
                address: $('#address').value.trim(),
                location: $('#location').value.trim(),
                itemDesc: $('#itemDesc').value.trim(),
                department: $('#department').value.trim(),
                gatePass: $('#gatePass').value.trim(),
                transportNo: $('#transportNo').value.trim(),
                driver: $('#driver').value.trim(),
                rows: collectRows(),
                totals: {
                    kg: $('#totalKg').textContent,
                    yds: $('#totalYds').textContent,
                    bag: $('#totalBag').textContent,
                    amount: $('#totalAmount').textContent
                },
                dollarMode: $('#dollarMode').checked, // ডলার মোড সেভ করা
                createdAt: new Date().toISOString()
            };
        }
        
        function fillForm(doc){
            $('#challanNo').textContent = doc.challanNo || '—';
            $('#billNo').textContent = doc.billNo || '—';
            $('#date').value = (doc.date || '').slice(0,10);
            $('#to').value = doc.to || '';
            $('#address').value = doc.address || '';
            $('#location').value = doc.location || '';
            $('#itemDesc').value = doc.itemDesc || '';
            $('#department').value = doc.department || '';
            $('#gatePass').value = doc.gatePass || '';
            $('#transportNo').value = doc.transportNo || '';
            $('#driver').value = doc.driver || '';
            $('#dollarMode').checked = doc.dollarMode || false; // ডলার মোড লোড করা
            setRows(doc.rows || []);
            updateTotals();
        }

        // ========== Firebase REST ==========
        async function fbPost(path, data){
            const res = await fetch(FIREBASE_BASE + path + '.json', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Save failed');
            return res.json(); // { name: "-Nx..." }
        }
        
        async function fbPatch(pathWithKey, data){
            const res = await fetch(FIREBASE_BASE + pathWithKey + '.json', {
                method: 'PATCH',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Update failed');
            return res.json();
        }

        // ========== Number to Words Conversion ==========
        function numberToWords(num) {
            if (num === 0) return 'Zero';
            
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const thousands = ['', 'Thousand', 'Million', 'Billion'];
            
            function convertHundreds(n) {
                let result = '';
                if (n >= 100) {
                    result += ones[Math.floor(n / 100)] + ' Hundred ';
                    n %= 100;
                }
                if (n >= 20) {
                    result += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                } else if (n >= 10) {
                    result += teens[n - 10] + ' ';
                    return result.trim();
                }
                if (n > 0) {
                    result += ones[n] + ' ';
                }
                return result.trim();
            }
            
            if (num < 0) return 'Negative ' + numberToWords(-num);
            
            let result = '';
            let thousandCounter = 0;
            
            while (num > 0) {
                if (num % 1000 !== 0) {
                    result = convertHundreds(num % 1000) + ' ' + thousands[thousandCounter] + ' ' + result;
                }
                num = Math.floor(num / 1000);
                thousandCounter++;
            }
            
            return result.trim();
        }

        function formatAmountInWords(amount) {
            const amountStr = typeof amount === 'string' ? amount : String(amount);
            const isDollar = amountStr.includes('$');
            const isBDT = amountStr.includes('BDT');
            
            // Remove currency symbols and get numeric value
            const cleanAmount = amountStr.replace('$', '').replace('BDT', '').trim();
            const numAmount = parseFloat(cleanAmount) || 0;
            if (numAmount === 0) return '';
            
            const integerPart = Math.floor(numAmount);
            const decimalPart = Math.round((numAmount - integerPart) * 100);
            
            let words = numberToWords(integerPart);
            
            if (isDollar) {
                // For dollars
                words += ' Dollar' + (integerPart !== 1 ? 's' : '');
                if (decimalPart > 0) {
                    words += ' and ' + numberToWords(decimalPart) + ' Cent' + (decimalPart !== 1 ? 's' : '');
                }
            } else {
                // For Taka (Bangladeshi currency) - both BDT and default
                words += ' Taka';
                if (decimalPart > 0) {
                    words += ' and ' + numberToWords(decimalPart) + ' Paisa';
                }
            }
            
            return words + ' Only';
        }

        // ========== Print (BILL shows Rate/Amount, Challan hides) ==========
        function openPrintable(titleText, extra = {}) {
            const data = {
                ...collectForm(),
                billNo: extra.billNo || $('#billNo').textContent.trim()
            };
            const win = window.open('', '_blank');
            if (!win) { alert('পপআপ ব্লকার বন্ধ করুন বা নতুন ট্যাব খোলার অনুমতি দিন।'); return; }

            const isChallan = titleText === 'DELIVERY CHALLAN';
            
            const styles = `
                <style>
                    * { box-sizing: border-box; }
                    body { font-family: 'Times New Roman', Times, serif; padding: 18px; color: #000; font-size: 15px; }
                    .wrap { max-width: 900px; margin: 0 auto; }
                    .challan-copy { margin-bottom: 40px; page-break-inside: avoid; }
                    .challan-copy:last-child { margin-bottom: 0; }
                    .copy-label { text-align: center; font-weight: bold; font-size: 16px; color: #000; margin-bottom: 15px; text-decoration: underline; }
                    .head { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
                    .logo { font-weight: 800; font-size: 22px; color: #000; }
                    .title { color: #000; font-weight:700; font-size: 16px; }
                    .meta { border:1px solid #000; border-radius:8px; padding:10px; min-width:260px; font-size: 14px; color: #000; }
                    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
                    .field { margin-bottom: 8px; }
                    .field label { display:inline; font-size:13px; color:#000; font-weight: 600; margin-right: 8px; }
                    .value { font-weight:700; font-size: 14px; color: #000; }
                    table { width:100%; border-collapse: collapse; margin-top: 14px; font-size: 14px; color: #000; }
                    th, td { border:1px solid #000; padding: 9px; color: #000; }
                    th { background:#f8f9fa; text-align:left; font-weight:700; font-size: 14px; color: #000; }
                    tfoot td { background:#f1f5f9; font-weight:800; border-top:2px solid #000; font-size: 14px; color: #000; }
                    .foot { display:flex; justify-content: space-between; gap: 12px; margin-top: 80px; }
                    .sign { border-top:2px solid #000; padding-top:16px; text-align:center; min-width:180px; height:120px; font-size: 14px; color: #000; font-weight: 600; }
                    .actions { display:flex; gap:8px; margin: 10px 0 18px; }
                    .btn { padding: 8px 12px; border: 0; border-radius: 6px; cursor: pointer; font-size: 14px; }
                    .btn-print { background:#2563eb; color:#fff; }
                    .btn-close { background:#e2e8f0; }
                    .col-rate, .col-amount { display: table-cell; }
                    ${titleText !== 'BILL' ? '.col-rate, .col-amount { display: none; }' : ''}
                    @media print { 
                        .actions { display:none; } 
                        th, td { border: 0.5px solid #000 !important; color: #000 !important; }
                        table { border: 0.8px solid #000; color: #000 !important; }
                        .meta { border: 0.8px solid #000; color: #000 !important; }
                        body { font-size: 15px; color: #000 !important; }
                        table { font-size: 14px; color: #000 !important; }
                        .logo { font-size: 22px; color: #000 !important; }
                        .title { font-size: 16px; color: #000 !important; }
                        .value { color: #000 !important; }
                        .field label { color: #000 !important; }
                        .sign { color: #000 !important; border-top: 1px solid #000 !important; height: 120px !important; }
                        .copy-label { color: #000 !important; }
                        * { color: #000 !important; }
                    }
                </style>
            `;

            const rowsHtml = (data.rows||[]).map(r => `
                <tr>
                    <td>${r.sl}</td>
                    <td>${r.order || '-'}</td>
                    <td>${r.colour || '-'}</td>
                    <td>${r.measurement || '-'}</td>
                    <td>${r.process || '-'}</td>
                    <td style="text-align:center">${r.uom || '-'}</td>
                    <td style="text-align:right">${r.kg || ''}</td>
                    <td style="text-align:right">${r.yds || ''}</td>
                    <td style="text-align:right">${r.bag || ''}</td>
                    <td class="col-rate" style="text-align:right">${r.rate || ''}</td>
                    <td class="col-amount" style="text-align:right">${r.amount || ''}</td>
                    <td>${r.remarks || ''}</td>
                </tr>
            `).join('');

            const isBill = titleText === 'BILL';
            const numberLabel = isBill ? 'Bill No' : 'Challan No';
            const numberValue = isBill ? (data.billNo || '-') : (data.challanNo || '-');

            // Show both numbers in bill print
            const numberDisplay = isBill ? 
                `<div><strong>Bill No:</strong> ${data.billNo || '-'}</div>
                 <div style="margin-top:6px"><strong>Challan No:</strong> ${data.challanNo || '-'}</div>` :
                `<div><strong>Challan No:</strong> ${data.challanNo || '-'}</div>`;

            // Create the content template for each copy
            const createCopyContent = (copyLabel) => `
                <div class="challan-copy">
                    ${isChallan ? `<div class="copy-label">${copyLabel}</div>` : ''}
                    
                    <div class="head">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="width: 60px; height: 60px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; flex-shrink: 0;">
                                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFoZoF_UQFDZ0WIcogBokuYyvqzzKr_TMibzKjBQyPDZSXK3kc5zPUyyIqJ4_WunT8HKXEtSIE8-g_GdKl50_bbERjV-TTMl_7B7CpQJ87E-tR3XoZs9kSFwsotGIaKTQL2xOFsp9bPJOyUUOcipV9oN45FYpst4LTwEe3f84jhyKTMVulcUvNi-kRRam2/s320-rw/GMS-Composite-Knitting-Ind.-Ltd.png" alt="GMS Logo" style="width: 50px; height: 50px; object-fit: contain; border-radius: 6px;" onerror="this.style.display='none';">
                            </div>
                            <div>
                                <div class="logo">GMS Composite Knitting Ind Ltd</div>
                                <div style="font-size:12px; color:#666; margin-top:2px;">Sardagonj, Kashimpur, Gazipur</div>
                                <div class="title" style="margin-top:4px;">${titleText}</div>
                            </div>
                        </div>
                        <div class="meta">
                            ${numberDisplay}
                            <div style="margin-top:6px"><strong>Date:</strong> ${data.date}</div>
                        </div>
                    </div>

                    <section class="grid">
                        <div>
                            <div class="field"><label>To:</label> <span class="value">${data.to || 'Gms Trims Ltd.'}</span></div>
                            <div class="field"><label>Address:</label> <span class="value">${data.address || 'Shardagonj,Kashimpur,Gazipur.'}</span></div>
                            <div class="field"><label>Location:</label> <span class="value">${data.location || '-'}</span></div>
                            <div class="field"><label>Item Description / Elastic Type:</label> <span class="value">${data.itemDesc || '-'}</span></div>
                            <div class="field"><label>Department:</label> <span class="value">${data.department || '-'}</span></div>
                        </div>
                        <div>
                            <div class="field"><label>Gate Pass No:</label> <span class="value">${data.gatePass || '-'}</span></div>
                            <div class="field"><label>Transport No:</label> <span class="value">${data.transportNo || '-'}</span></div>
                            <div class="field"><label>Driver's Name:</label> <span class="value">${data.driver || '-'}</span></div>
                        </div>
                    </section>

                    <table>
                        <thead>
                            <tr>
                                <th>SL. NO</th>
                                <th>Order No</th>
                                <th>Colour</th>
                                <th>Measurement</th>
                                <th>Process</th>
                                <th>UoM</th>
                                <th>Kg</th>
                                <th>Yds</th>
                                <th>Bag</th>
                                <th class="col-rate">Rate</th>
                                <th class="col-amount">Amount</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml || '<tr><td colspan="12" style="text-align:center;color:#64748b">No items</td></tr>'}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6">Total</td>
                                <td style="text-align:right">${data.totals.kg}</td>
                                <td style="text-align:right">${data.totals.yds}</td>
                                <td style="text-align:right">${data.totals.bag}</td>
                                <td class="col-rate" style="text-align:right">—</td>
                                <td class="col-amount" style="text-align:right">${data.totals.amount}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>

                    ${isBill ? `
                    <div style="margin-top: 20px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: #f8f9fa;">
                        <div style="font-weight: 600; margin-bottom: 6px;">Amount in Words:</div>
                        <div style="font-style: italic; color: #374151;">${formatAmountInWords(data.totals.amount)}</div>
                    </div>
                    ` : ''}

                    <div class="foot">
                        <div class="sign">Prepared By</div>
                        <div class="sign">Receiver's Signature</div>
                        <div class="sign">Checked By</div>
                        <div class="sign">Approved By</div>
                    </div>
                </div>
            `;

            // Generate content based on document type
            let mainContent;
            if (isChallan) {
                // For challan, show two copies
                mainContent = createCopyContent('FIRST COPY') + createCopyContent('SECOND COPY');
            } else {
                // For bill, show single copy without copy label
                mainContent = createCopyContent('');
            }

            const html = `
                <html>
                    <head>
                        <meta charset="utf-8"/>
                        <meta name="viewport" content="width=device-width,initial-scale=1"/>
                        <title>${titleText} - ${numberValue}</title>
                        ${styles}
                    </head>
                    <body>
                        <div class="wrap">
                            <div class="actions">
                                <button class="btn btn-print" onclick="window.print()">Print</button>
                                <button class="btn btn-close" onclick="window.close()">Close</button>
                            </div>

                            ${mainContent}
                        </div>
                    </body>
                </html>
            `;
            win.document.open(); win.document.write(html); win.document.close();
        }

        function initializeDropdownSystem() {
            // ========== Company Dropdown Logic ==========
            const toInput = $('#to');
            const toDropdown = $('#toDropdown');
            const companyOptions = $$('.company-option');

            // Show dropdown on focus
            toInput.addEventListener('focus', () => {
                toDropdown.classList.remove('hidden');
                filterCompanies(toInput.value);
            });

            // Filter companies as user types
            toInput.addEventListener('input', (e) => {
                filterCompanies(e.target.value);
                toDropdown.classList.remove('hidden');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#to') && !e.target.closest('#toDropdown')) {
                    toDropdown.classList.add('hidden');
                }
            });

            // Handle company selection
            companyOptions.forEach(option => {
                option.addEventListener('click', () => {
                    toInput.value = option.textContent;
                    toDropdown.classList.add('hidden');
                    toInput.focus();
                });
            });

            // Filter function
            function filterCompanies(searchText) {
                const search = searchText.toLowerCase();
                companyOptions.forEach(option => {
                    const companyName = option.textContent.toLowerCase();
                    if (companyName.includes(search)) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }

            // ========== Address Dropdown Logic ==========
            const addressInput = $('#address');
            const addressDropdown = $('#addressDropdown');
            const addressOptions = $$('.address-option');

            // Show dropdown on focus
            addressInput.addEventListener('focus', () => {
                addressDropdown.classList.remove('hidden');
                filterAddresses(addressInput.value);
            });

            // Filter addresses as user types
            addressInput.addEventListener('input', (e) => {
                filterAddresses(e.target.value);
                addressDropdown.classList.remove('hidden');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#address') && !e.target.closest('#addressDropdown')) {
                    addressDropdown.classList.add('hidden');
                }
            });

            // Handle address selection
            addressOptions.forEach(option => {
                option.addEventListener('click', () => {
                    addressInput.value = option.textContent;
                    addressDropdown.classList.add('hidden');
                    addressInput.focus();
                });
            });

            // Filter function for addresses
            function filterAddresses(searchText) {
                const search = searchText.toLowerCase();
                addressOptions.forEach(option => {
                    const addressName = option.textContent.toLowerCase();
                    if (addressName.includes(search)) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }

            // ========== Location Dropdown Logic ==========
            const locationInput = $('#location');
            const locationDropdown = $('#locationDropdown');
            const locationOptions = $$('.location-option');

            // Show dropdown on focus
            locationInput.addEventListener('focus', () => {
                locationDropdown.classList.remove('hidden');
                filterLocations(locationInput.value);
            });

            // Filter locations as user types
            locationInput.addEventListener('input', (e) => {
                filterLocations(e.target.value);
                locationDropdown.classList.remove('hidden');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#location') && !e.target.closest('#locationDropdown')) {
                    locationDropdown.classList.add('hidden');
                }
            });

            // Handle location selection
            locationOptions.forEach(option => {
                option.addEventListener('click', () => {
                    locationInput.value = option.textContent;
                    locationDropdown.classList.add('hidden');
                    locationInput.focus();
                });
            });

            // Filter function for locations
            function filterLocations(searchText) {
                const search = searchText.toLowerCase();
                locationOptions.forEach(option => {
                    const locationName = option.textContent.toLowerCase();
                    if (locationName.includes(search)) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }

            // ========== Department Dropdown Logic ==========
            const departmentInput = $('#department');
            const departmentDropdown = $('#departmentDropdown');
            const departmentOptions = $$('.department-option');

            // Show dropdown on focus
            departmentInput.addEventListener('focus', () => {
                departmentDropdown.classList.remove('hidden');
                filterDepartments(departmentInput.value);
            });

            // Filter departments as user types
            departmentInput.addEventListener('input', (e) => {
                filterDepartments(e.target.value);
                departmentDropdown.classList.remove('hidden');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#department') && !e.target.closest('#departmentDropdown')) {
                    departmentDropdown.classList.add('hidden');
                }
            });

            // Handle department selection
            departmentOptions.forEach(option => {
                option.addEventListener('click', () => {
                    departmentInput.value = option.textContent;
                    departmentDropdown.classList.add('hidden');
                    departmentInput.focus();
                });
            });

            // Filter function for departments
            function filterDepartments(searchText) {
                const search = searchText.toLowerCase();
                departmentOptions.forEach(option => {
                    const departmentName = option.textContent.toLowerCase();
                    if (departmentName.includes(search)) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }
        }

        function initializeFormControls() {
            // Track loaded doc for updates
            let loadedDoc = null; // { type: 'documents', key: '-Nx...' }
            
            // ========== Dark Mode System ==========
            const darkModeToggle = $('#darkModeToggle');
            const darkModeIcon = $('#darkModeIcon');
            const darkModeText = $('#darkModeText');
            const body = document.body;
            
            // Check saved dark mode preference
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                enableDarkMode();
            }
            
            // Dark mode toggle handler
            darkModeToggle.addEventListener('click', function() {
                if (body.classList.contains('dark-mode')) {
                    disableDarkMode();
                } else {
                    enableDarkMode();
                }
            });
            
            function enableDarkMode() {
                body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
                
                // Update button appearance
                darkModeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                `;
                darkModeText.textContent = 'Light';
                darkModeToggle.className = darkModeToggle.className.replace('from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800', 'from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800');
                
                showToast('ডার্ক মোড চালু করা হয়েছে');
            }
            
            function disableDarkMode() {
                body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
                
                // Update button appearance
                darkModeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                `;
                darkModeText.textContent = 'Dark';
                darkModeToggle.className = darkModeToggle.className.replace('from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800', 'from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800');
                
                showToast('লাইট মোড চালু করা হয়েছে');
            }
            
            // Dollar mode checkbox handler
            $('#dollarMode').addEventListener('change', function() {
                updateTotals();
                const mode = this.checked ? 'ডলার চিহ্ন যোগ করা হয়েছে' : 'ডলার চিহ্ন সরানো হয়েছে';
                showToast(mode);
            });

            // ========== Buttons ==========
            $('#addRow').addEventListener('click', e => { e.preventDefault(); addRow(); });
            
            $('#resetForm').addEventListener('click', e => {
                e.preventDefault();
                if (!confirm('নতুন ডাটা এন্ট্রির জন্য ফর্ম ক্লিয়ার করবেন?')) return;
                
                // Clear loaded document reference
                loadedDoc = null;
                
                // Reset to completely fresh state
                resetToFreshState();
                
                // Add one empty row for new entry
                addRow();
                updateTotals();
                
                showToast('ফর্ম রিফ্রেশ হয়েছে - নতুন ডাটা এন্ট্রির জন্য প্রস্তুত');
            });

            // Save to Firebase (separate save button)
            $('#saveToFirebase').addEventListener('click', async e=>{
                e.preventDefault();
                
                // Prevent saving if document is loaded from search
                if (loadedDoc) {
                    showToast('সার্চ করা ডাটা সেভ করা যাবে না - "আপডেট সংরক্ষণ" ব্যবহার করুন', false);
                    return;
                }
                
                try {
                    showToast('সেভ করা হচ্ছে...');
                    
                    // Create new document with only challan number (bill number generated separately)
                    const challanNo = await generateChallanNumber();
                    $('#challanNo').textContent = challanNo;
                    // Keep bill number as "—" until bill is generated
                    $('#billNo').textContent = '—';
                    
                    const doc = collectForm();
                    doc.challanNo = challanNo;
                    doc.billNo = '—'; // No bill number yet
                    doc.kind = 'SAVED';
                    
                    // Always create new document (POST)
                    const res = await fbPost('documents', doc);
                    
                    showToast(`চালান সেভ হয়েছে - ${challanNo}`);
                    
                    // Clear all form fields after successful save
                    resetToFreshState();
                    
                    // Add one empty row for new entry
                    addRow();
                    
                    // Clear loaded document reference for fresh start
                    loadedDoc = null;
                    
                } catch (err) {
                    console.error(err);
                    showToast('সেভ করতে সমস্যা হয়েছে', false);
                }
            });
            
            // Function to reset form for new entry
            function resetForNewEntry() {
                // Clear loaded document reference
                loadedDoc = null;
                
                // Reset to completely fresh state
                resetToFreshState();
                
                // Add one empty row
                addRow();
                updateTotals();
                
                showToast('নতুন চালানের জন্য প্রস্তুত');
            }

            // New Challan button handler
            $('#newChallanBtn').addEventListener('click', e => {
                e.preventDefault();
                if (confirm('নতুন চালান তৈরি করতে চান? বর্তমান তথ্য সেভ করা হয়েছে।')) {
                    resetForNewEntry();
                }
            });

            // Generate BILL (generate new bill number and update Firebase)
            $('#generateBill').addEventListener('click', async e=>{
                e.preventDefault();
                let billNo = $('#billNo').textContent.trim();
                
                // Always generate new bill number when creating bill
                if (!billNo || billNo === '—') {
                    try {
                        showToast('বিল নাম্বার তৈরি করা হচ্ছে...');
                        billNo = await generateBillNumber();
                        $('#billNo').textContent = billNo;
                        
                        // Update Firebase with bill number if document exists
                        if (loadedDoc) {
                            await fbPatch(`${loadedDoc.type}/${loadedDoc.key}`, { billNo: billNo });
                        }
                        
                        showToast(`নতুন বিল নাম্বার: ${billNo}`);
                    } catch (err) {
                        console.error(err);
                        showToast('বিল নাম্বার তৈরি করতে সমস্যা', false);
                        return;
                    }
                } else {
                    showToast(`বিল প্রিন্ট: ${billNo}`);
                }
                
                openPrintable('BILL', { billNo });
            });

            // Generate CHALLAN (generate new challan number and update Firebase)
            $('#generateChallan').addEventListener('click', async e=>{
                e.preventDefault();
                let challanNo = $('#challanNo').textContent.trim();
                
                // Generate new challan number if needed
                if (!challanNo || challanNo === 'CH-2025-00001' || challanNo === '—') {
                    try {
                        showToast('চালান নাম্বার তৈরি করা হচ্ছে...');
                        challanNo = await generateChallanNumber();
                        $('#challanNo').textContent = challanNo;
                        
                        // Update Firebase with challan number if document exists
                        if (loadedDoc) {
                            await fbPatch(`${loadedDoc.type}/${loadedDoc.key}`, { challanNo: challanNo });
                        }
                        
                        showToast(`নতুন চালান নাম্বার: ${challanNo}`);
                    } catch (err) {
                        console.error(err);
                        showToast('চালান নাম্বার তৈরি করতে সমস্যা', false);
                        return;
                    }
                } else {
                    showToast(`চালান প্রিন্ট: ${challanNo}`);
                }
                
                openPrintable('DELIVERY CHALLAN');
            });

            // Search & Load by number (Bill No or Challan No)
            $('#searchBtn').addEventListener('click', async e=>{
                e.preventDefault();
                const query = $('#searchNumber').value.trim().toUpperCase();
                if (!query) { showToast('নাম্বার লিখুন', false); return; }
                try {
                    let found = null;
                    
                    // Search in documents collection
                    const docsRes = await fetch(`${FIREBASE_BASE}documents.json`);
                    if (docsRes.ok) {
                        const docs = await docsRes.json();
                        if (docs) {
                            for (const [key, doc] of Object.entries(docs)) {
                                const docBillNo = (doc.billNo || '').toUpperCase();
                                const docChallanNo = (doc.challanNo || '').toUpperCase();
                                if (docBillNo === query || docChallanNo === query) {
                                    found = { type:'documents', key, doc };
                                    break;
                                }
                            }
                        }
                    }

                    if (!found) { 
                        showToast(`"${query}" পাওয়া যায়নি`, false); 
                        return; 
                    }
                    
                    fillForm(found.doc);
                    loadedDoc = { type: found.type, key: found.key };
                    $('#saveUpdatesBtn').classList.remove('hidden');
                    showToast(`লোড হয়েছে: ${found.doc.challanNo || ''} ${found.doc.billNo || ''}`);
                } catch (err) {
                    console.error(err);
                    showToast('লোড করতে সমস্যা হয়েছে', false);
                }
            });

            // Save updates to loaded doc
            $('#saveUpdatesBtn').addEventListener('click', async e=>{
                e.preventDefault();
                if (!loadedDoc) { showToast('লোড করা ডকুমেন্ট নেই', false); return; }
                try {
                    const payload = collectForm();
                    await fbPatch(`${loadedDoc.type}/${loadedDoc.key}`, payload);
                    showToast('আপডেট সেভ হয়েছে');
                } catch (err) {
                    console.error(err);
                    showToast('আপডেট সেভ ব্যর্থ', false);
                }
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98998eb8a7b8daef',t:'MTc1OTYzMjA2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
    
  </body>
  
</html>
